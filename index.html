<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensiklopedia Nur v10.6 (MicroExpression)</title>
    
    <!-- Tailwind CSS CDN untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Noto Naskh Arabic untuk teks Arab -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">

    <!-- Library untuk Export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.min.js"></script>
     
    <style>
        /* --- Gaya Responsif Mobile (Versi NON-STICKY) --- */
        @media (max-width: 768px) {
            /* (1) Atur tata letak utama menjadi tumpukan vertikal */
            .flex.h-screen {
                flex-direction: column;
                height: auto;
            }

            /* (2) Jadikan 'aside' sebagai header statis biasa (ikut scroll) */
            aside {
                position: static !important; /* MEMASTIKAN TIDAK ADA STICKY */
                width: 100% !important;
                height: auto !important;
                background-color: #111827; /* Warna latar header */
                padding: 1rem;
                border-bottom: 1px solid #374151;
            }

            /* (3) Atur judul dan navigasi di dalam header */
            aside .mb-8 {
                text-align: center;
                margin-bottom: 1rem;
            }
            #main-nav {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Sembunyikan scrollbar di Firefox */
            }
            #main-nav::-webkit-scrollbar {
                display: none; /* Sembunyikan scrollbar di Chrome, Safari */
            }
            .nav-item {
                flex-shrink: 0;
                white-space: nowrap;
                margin-right: 0.5rem;
            }
            .nav-item.status-loading {
                background-color: #d97706; /* bg-amber-600 */
                color: #ffffff;
            }
            .nav-item.status-loaded {
                background-color: #059669; /* bg-emerald-600 */
                color: #ffffff;
            }
            /* (4) Atur area konten utama */
            main {
                margin-left: 0 !important;
                padding: 1.5rem 1rem; /* Padding normal, tidak perlu ganjalan */
                flex-grow: 1;
            }

            /* (5) Pastikan panel di dalam konten juga satu kolom */
            #pillar-container, 
            #exportable-content .grid,
            #unified-search-panel .max-w-md,
            #settings-panel .max-w-xl {
                grid-template-columns: 1fr;
                max-width: 100%;
            }
        }
        /* --- Gaya Umum --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; /* bg-gray-900 */
            color: #e5e7eb; /* text-gray-200 */
            scroll-behavior: smooth; 
        }
        /* Font khusus untuk teks Arab */
        .font-arabic {
            font-family: 'Noto Naskh Arabic', serif;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        
        /* --- Navigasi Sidebar --- */
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            color: #9ca3af;
        }
        .nav-item:hover {
            background-color: #1f2937; /* bg-gray-800 */
            color: #f9fafb; /* text-gray-50 */
        }
        #main-nav.db-unloaded .nav-item:not([data-view="settings"]) {
            background-color: #ca8a04; /* Warna Kuning */
            color: #ffffff;
        }
        .nav-item.active {
            background-color: #059669; /* Warna Hijau */
            color: #ffffff;
            font-weight: 600;
}
        .nav-item svg {
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
        }

        /* --- Visibilitas Panel --- */
        .panel { display: none; }
        .panel-active { display: block; }
        
        /* --- Gaya Spesifik Fitur --- */
        .dictation-btn.recording svg {
            color: #ef4444; /* text-red-500 */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .secure-feature-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .group-btn {
            background-color: #374151; /* bg-gray-700 */
            transition: background-color 0.2s;
            width: 100%;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
        }
        .group-btn:hover {
            background-color: #4b5563; /* bg-gray-600 */
        }
        .pillar-item {
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
        }
        .pillar-item:hover {
            background-color: #374151; /* bg-gray-700 */
            color: #10b981; /* text-emerald-500 */
        }

        /* Gaya untuk Accordion Tafsir & Asbabun Nuzul */
        details summary {
            cursor: pointer;
            font-weight: 600;
            color: #34d399; /* emerald-400 */
            transition: color 0.2s;
            list-style: none; /* Hapus panah default */
            display: flex;
            align-items: center;
        }
        details summary::-webkit-details-marker {
            display: none; /* Hapus panah di Chrome/Safari */
        }
        details summary:hover {
            color: #6ee7b7; /* emerald-300 */
        }
        details summary::before {
            content: 'â–º';
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        details > div {
            padding: 0.75rem;
            margin-top: 0.5rem;
            background-color: #1f2937; /* bg-gray-800 */
            border-left: 2px solid #10b981; /* border-emerald-500 */
            border-radius: 0 0.375rem 0.375rem 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="flex h-screen">
        <aside class="w-64 bg-gray-800/50 p-4 flex flex-col fixed h-full overflow-y-auto">
            <div class="mb-8 text-center">
                <h1 class="text-2xl font-bold text-white">Ensiklopedia Nur</h1>
                <p class="text-sm text-emerald-400">v10.6 (MicroExpression)</p>
            </div>
            <nav id="main-nav" class="flex-grow space-y-2 db-unloaded">
                <button class="nav-item status-indicator status-loading active" data-view="unified-search"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>IDEA</button>
                <button class="nav-item status-indicator status-loading" data-view="image"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>camera</button>
                <button class="nav-item" data-view="settings"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.57 6.57 0 01-.22.127c-.332.183-.582.495-.645.87l-.213 1.281c-.09.542-.56.94-1.11-.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.003-.827c.293.24.438.613-.438.995s-.145-.755-.438-.995l-1.003-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37.49l1.217.456c.355.133.75.072 1.075-.124.072-.044.146-.087.22-.127.332-.183.582.495.645-.87l.213-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>DATA</button>
            </nav>
        </aside>

        <main class="ml-64 flex-1 p-8 overflow-y-auto">
            <div id="dashboard-panel" class="panel panel-active"></div>
            <div id="unified-search-panel" class="panel"></div>
            <div id="image-panel" class="panel"></div>
            <div id="settings-panel" class="panel"></div>
            
            <div id="results-container" class="w-full mx-auto mt-8"></div>
        </main>
    </div>
    
    <script>
    const emotionTaxonomy = {
        "primary_emotions": [
            { "name": "Happiness", "aliases": ["joy", "pleasure", "delight"], "microexpressions": ["lip corners raised (Duchenne smile)", "cheeks raised", "wrinkles near eyes (crowâ€™s feet)"] },
            { "name": "Sadness", "aliases": ["sorrow", "grief", "melancholy"], "microexpressions": ["inner eyebrows raised", "corners of lips pulled down", "chin pushed up"] },
            { "name": "Anger", "aliases": ["rage", "annoyance", "irritation"], "microexpressions": ["brows lowered and drawn together", "eyes glaring", "lips pressed tightly"] },
            { "name": "Fear", "aliases": ["anxiety", "terror", "nervousness"], "microexpressions": ["eyebrows raised and drawn together", "upper eyelids raised", "mouth slightly open"] },
            { "name": "Surprise", "aliases": ["astonishment", "amazement"], "microexpressions": ["eyebrows raised", "eyes wide open", "mouth open in O shape"] },
            { "name": "Disgust", "aliases": ["revulsion", "distaste"], "microexpressions": ["nose wrinkling", "upper lip raised", "brows lowered"] },
            { "name": "Contempt", "aliases": ["scorn", "disdain"], "microexpressions": ["lip corner tightened and raised on one side", "asymmetrical expression"] }
        ],
        "secondary_emotions": [
            { "name": "Embarrassment", "microexpressions": ["head tilt downward", "eyes looking away", "slight smile"] },
            { "name": "Guilt", "microexpressions": ["lowered head", "eyes averted", "eyebrows pulled together"] },
            { "name": "Shame", "microexpressions": ["head down", "cheeks flushed", "tight lips"] },
            { "name": "Pride", "microexpressions": ["head held high", "chin raised", "slight smile"] },
            { "name": "Love", "microexpressions": ["soft eyes", "relaxed facial muscles", "gentle smile"] },
            { "name": "Relief", "microexpressions": ["exhale visible", "shoulders drop", "relaxed brow"] },
            { "name": "Interest / Curiosity", "microexpressions": ["eyes focused and still", "eyebrows slightly raised", "head tilt"] },
            { "name": "Confusion", "microexpressions": ["furrowed brows", "head tilt", "lips slightly parted"] },
            { "name": "Frustration", "microexpressions": ["tense jaw", "pursed lips", "eyebrows furrowed"] },
            { "name": "Desire", "microexpressions": ["dilated pupils", "prolonged gaze", "lips parted"] }
        ],
        "suppressed_microexpressions": [
            { "name": "Suppressed Anger", "microexpression": "fleeting eyebrow movement, lip compression" },
            { "name": "Suppressed Joy", "microexpression": "brief smile with no eye wrinkles" },
            { "name": "Suppressed Disgust", "microexpression": "nose wrinkle that disappears instantly" }
        ],
        "social_expressions": [
            { "name": "Polite Smile", "microexpression": "lips curved up without eye involvement" },
            { "name": "Fake Agreement", "microexpression": "nodding with tense lips" },
            { "name": "Masking Emotion", "microexpression": "emotionless or neutral face while suppressing others" }
        ],
        "spiritual_or_contextual": [
            { "name": "Khusyuâ€™", "microexpressions": ["lowered gaze", "relaxed jaw", "face calm and peaceful"] },
            { "name": "Syukur", "microexpressions": ["gentle smile", "glowing eyes", "softened brow"] },
            { "name": "Takjub kepada ciptaan Allah", "microexpressions": ["wide eyes", "soft raised brows", "slightly parted lips"] },
            { "name": "Harap dan Cemas (Raja' dan Khauf)", "microexpressions": ["mixed expression of hope and worry", "eyebrows pulled upward, lips slightly tightened"] }
        ]
    };

    // --- FUNGSI-FUNGSI BARU UNTUK FITUR KAMERA CERDAS ---

    async function loadFaceApiModels() {
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
            console.log('Model Face Recognition berhasil dimuat.');
        } catch (error) {
            console.error('Gagal memuat model Face Recognition:', error);
            showError('Gagal memuat fitur pengenalan wajah. Coba refresh halaman.');
        }
    }

    async function generateMicroExpressionReport() {
        isAnalyzingVideo = false;
        showLoading('Membuat laporan analisis emosi kontekstual...');
        const videoEl = document.getElementById('camera-stream');
        const canvas = document.getElementById('camera-canvas');
        canvas.width = videoEl.videoWidth;
        canvas.height = videoEl.videoHeight;
        canvas.getContext('2d').drawImage(videoEl, 0, 0);
        const frameDataUrl = canvas.toDataURL('image/jpeg');
        const base64FrameData = frameDataUrl.split(',')[1];
        const prompt = `
    Anda adalah 'Paul Ekman', seorang psikolog profesional ahli mikro ekspresi dan emosi, juga mampu melihat dari sudut pandang islam

    **Data yang Dianalisis:**
    - **Rangkaian Ekspresi Terdeteksi (Face-API.js):** ${JSON.stringify(detectedEvents)}
    - **Inferensi Ekspresi (Berdasarkan Taksonomi Kustom):** ${JSON.stringify(inferredEvents)}
    - **Definisi Taksonomi Emosi Kustom:**
    ${JSON.stringify(emotionTaxonomy, null, 2)}
    - **Gambar Terlampir:** Frame terakhir dari video. Jika memungkinkan lakukan analisis dari SELURUH frame yang diperoleh.

    **Tugas Anda:**
    Buat laporan lengkap dalam format JSON. Ikuti struktur ini dengan ketat:
    1.  **visual_description**: Deskripsikan gambar terlampir secara detail dan terstruktur(objek, pencahayaan, suasana).
    2.  **emotion_analysis**: Berdasarkan rangkaian ekspresi yang terdeteksi dan inferensi ekspresi kustom, berikan interpretasi yang **sangat mendalam, detail, dan akurat**, berdasarkan keilmuan mikro ekspresi tentang kemungkinan perasaan atau pikiran subjek secara naratif. Gunakan frasa interpretatif seperti "ada indikasi..." atau "memberikan kesan...". Pertimbangkan juga definisi dari "Definisi Taksonomi Emosi Kustom" untuk analisis yang lebih kaya (misalnya tentang ekspresi yang ditekan, ekspresi sosial, atau spiritual). Berikan **DIAGNOSIS KLINIS** untuk debugging system.
    3.  **contextual_wisdom**: Berikan hikmah Islami yang relevan dengan situasi tersebut.
    4.  **references**: Sertakan 1-2 dalil (Al-Qur'an atau Hadis) yang mendukung hikmah Anda.
    5.  **follow_up_questions**: Berikan 2-3 pertanyaan reflektif untuk pengguna.
    BUAT KESIMPULAN SINGKAT PADA BAGIAN AKHIR DARI HASIL LAPORAN    
    PENTING: SAMPAIKAN DALAM BAHASA INDONESIA DAN Gunakan format sub-judul singkat jika perlu

    **STRUKTUR JSON OUTPUT (WAJIB):**
    {
    "visual_description": "(String)",
    "emotion_analysis": "(String)",
    "contextual_wisdom": "(String)",
    "references": [/* array objek Al-Qur'an/Hadis */],
    "follow_up_questions": [/* array pertanyaan */]
    }
    `;
        const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: 'image/jpeg', data: base64FrameData } }] }], generationConfig: { responseMimeType: "application/json" } };
        try {
            const resultData = await callGeminiAPI(payload);
            renderMicroExpressionReport(resultData, frameDataUrl);
        } catch (error) { showError(error.message); } finally { stopCamera(); }
    }

    // Fungsi untuk update status tombol navigasi
function updateNavStatus(isLoaded) {
    document.querySelectorAll('.nav-item.status-indicator').forEach(btn => {
        btn.classList.remove('status-loading', 'status-loaded', 'active'); // Hapus semua status lama
        if (isLoaded) {
            btn.classList.add('status-loaded');
        } else {
            btn.classList.add('status-loading');
        }
    });
    // Aktifkan kembali tombol yang seharusnya aktif
    const currentView = document.querySelector('.panel-active')?.id.replace('-panel', '');
    const currentNavButton = document.querySelector(`.nav-item[data-view="${currentView}"]`);
    if(currentNavButton) currentNavButton.classList.add('active');
}

    function renderMicroExpressionReport(data, frameDataUrl) {
        const resultsContainer = document.getElementById('results-container');
        if (!resultsContainer) return;
        const referensiHtml = renderReferensi(data.references);
        const followUpHtml = renderFollowUpQuestions(data.follow_up_questions);
        const reportHTML = `
            <div class="bg-gray-800/50 p-6 md:p-8 rounded-lg border border-sky-700 animate-fade-in">

                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-sky-400" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.522 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                        <span>Laporan Analisis Video</span>
                    </h2>

                    <div class="flex items-start gap-3">
                        <img src="${frameDataUrl}" alt="Hasil Capture Video" class="w-32 h-auto rounded-lg shadow-lg flex-shrink-0">
                        <button id="export-btn" class="p-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg transition-colors flex-shrink-0" title="Unduh Laporan sebagai PDF">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="exportable-content">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-sky-400 border-b border-sky-400/20 pb-2 mb-3">Deskripsi Visual Sinematik</h3>
                        <p class="text-gray-300 whitespace-pre-wrap text-sm leading-relaxed">${data.visual_description || 'Tidak ada deskripsi visual.'}</p>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-sky-400 border-b border-sky-400/20 pb-2 mb-3">Analisa Emosi & Perenungan</h3>
                        <p class="text-gray-300 whitespace-pre-wrap text-sm leading-relaxed">${data.emotion_analysis || 'Tidak ada analisis emosi.'}</p>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-sky-400 border-b border-sky-400/20 pb-2 mb-3">Hikmah & Nasihat Islami</h3>
                        <p class="text-gray-300 whitespace-pre-wrap text-sm leading-relaxed">${data.contextual_wisdom || 'Tidak ada hikmah yang bisa diambil.'}</p>
                    </div>

                    <div id="references-wrapper">${referensiHtml}</div>

                    ${followUpHtml}
                </div>

            </div>
            `;


        resultsContainer.innerHTML = reportHTML;
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
        // Simpan hasil ke cache setelah dirender
        panelResultsCache['image'] = resultsContainer.innerHTML;
    }
    // Fungsi utama untuk analisis video stream
    async function analyzeVideoStream() {
        // Bagian ini akan menghentikan loop jika analisis dihentikan dari tombol
        if (!isAnalyzingVideo) {
            const captureBtn = document.querySelector('#capture-btn');
            // Pastikan tombol direset ke status "Mulai Analisa" (biru)
            if (captureBtn) {
                captureBtn.innerText = "Mulai Analisa";
                captureBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                captureBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
            return;
        }

        const videoEl = document.getElementById('camera-stream');
        const detection = await faceapi.detectSingleFace(videoEl, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceExpressions();

        if (detection) {
            const expressions = detection.expressions;
            const currentExpression = Object.keys(expressions).reduce((a, b) => expressions[a] > expressions[b] ? a : b);

            const currentExpressionScore = expressions[currentExpression]; // Dapatkan skor kepercayaan
            expressionHistory.push({ expression: currentExpression, score: currentExpressionScore }); // Simpan objek {ekspresi, skor}
            // START LOGIKA INFERENSI BARU DI SINI
        const lastInferredEvent = inferredEvents[inferredEvents.length - 1];
        let newInference = null;

        // Contoh sederhana inferensi untuk Suppressed Joy:
        // Jika ekspresi dominan saat ini adalah 'neutral' tetapi sebelumnya ada 'happy' yang singkat dengan skor rendah,
        // atau jika ekspresi 'happy' itu sendiri memiliki skor kepercayaan yang rendah secara konsisten dalam sejarah singkat.
        const happyInHistory = expressionHistory.filter(h => h.expression === 'happy');
        if (currentExpression === 'neutral' && happyInHistory.length > 0 && happyInHistory.length < (HISTORY_LENGTH * 0.3) && happyInHistory[0].score < 0.7) {
            if (!lastInferredEvent || lastInferredEvent.name !== 'Suppressed Joy') {
                newInference = {
                    type: "suppressed_emotion",
                    name: "Suppressed Joy",
                    reason: "Brief, low-intensity happy expression followed by neutral state. Consistent with 'brief smile with no eye wrinkles' from taxonomy."
                };
            }
        }
        // Contoh sederhana inferensi untuk Suppressed Anger:
        // Jika ekspresi dominan saat ini adalah 'neutral' tetapi sebelumnya ada 'angry' yang singkat dengan skor rendah.
        const angryInHistory = expressionHistory.filter(h => h.expression === 'angry');
        if (currentExpression === 'neutral' && angryInHistory.length > 0 && angryInHistory.length < (HISTORY_LENGTH * 0.3) && angryInHistory[0].score < 0.7) {
             if (!lastInferredEvent || lastInferredEvent.name !== 'Suppressed Anger') {
                 newInference = {
                     type: "suppressed_emotion",
                     name: "Suppressed Anger",
                     reason: "Brief, low-intensity angry expression followed by neutral state. Consistent with 'fleeting eyebrow movement, lip compression' from taxonomy."
                 };
             }
         }

        // Tambahkan inferensi baru jika ada
        if (newInference) {
            const timestamp = ((Date.now() - analysisStartTime) / 1000).toFixed(1);
            inferredEvents.push({ ...newInference, timestamp: `${timestamp}s` });
        }
        // END LOGIKA INFERENSI BARU DI SINI
            if (expressionHistory.length > HISTORY_LENGTH) {
                expressionHistory.shift();
            }

            const lastEvent = detectedEvents[detectedEvents.length - 1];

            if (!lastEvent || lastEvent.expression !== currentExpression) {
                const timestamp = ((Date.now() - analysisStartTime) / 1000).toFixed(1);
                detectedEvents.push({ expression: currentExpression, timestamp: `${timestamp}s` });
                console.log(detectedEvents);
            }

            const neutralCount = expressionHistory.filter(exp => exp.expression === 'neutral').length;
            if (currentExpression !== 'neutral' && neutralCount > HISTORY_LENGTH * 0.7) {
                console.log(`MICRO EXPRESSION TERDETEKSI: ${currentExpression}. Membuat laporan...`);
                generateMicroExpressionReport();
            }
        }

        requestAnimationFrame(analyzeVideoStream);
    }


    // --- VARIABEL GLOBAL & KONTROL KEAMANAN ---
    const isSecureContext = window.isSecureContext;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const hasCameraSupport = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;

    // Variabel-variabel yang perlu diakses secara global
    let currentStream = null; // Inisialisasi ke null
    let isAnalyzingVideo = false;
    let expressionHistory = []; // Sekarang menyimpan objek { expression: string, score: number }
    const HISTORY_LENGTH = 20; // Menyimpan histori 15 frame terakhir (sekitar 0.5 detik pada 30fps)
    let analysisStartTime = 0;
    let detectedEvents = [];
    let inferredEvents = []; // VARIABEL BARU UNTUK INFERENSI DARI emotionTaxonomy

    let loadedDatabase = []; // Pastikan ini juga global
    let currentReferences = []; // Pastikan ini juga global
    let currentReferencePage = 0; // Pastikan ini juga global
    const REFERENCES_PER_PAGE_QURAN = 10; // Pastikan ini juga global
    const REFERENCES_PER_PAGE_HADITH = 5; // Pastikan ini juga global

    // Cache baru untuk menyimpan hasil spesifik per panel
    const panelResultsCache = {};

    // Fungsi stopCamera dipindahkan ke lingkup global
    const stopCamera = () => {
        console.log("stopCamera() function called."); // Log untuk diagnostik
        if (currentStream) {
            currentStream.getTracks().forEach(track => {
                track.stop();
                console.log("Track stopped:", track.kind); // Log setiap track yang dihentikan
            });
            currentStream = null; // Penting: Hapus referensi stream
        }
        isAnalyzingVideo = false;
        expressionHistory = [];
        detectedEvents = []; // Reset detected events saat berhenti
        inferredEvents = []; // RESET INFERRED EVENTS DI SINI

        // Amankan akses ke elemen DOM karena mungkin belum sepenuhnya dimuat atau terlihat
        const imageControls = document.getElementById('image-controls');
        const captureControls = document.getElementById('capture-controls');
        const cameraStream = document.getElementById('camera-stream');
        const imagePlaceholder = document.getElementById('image-placeholder');
        const imagePreview = document.getElementById('image-preview');
        const captureBtn = document.getElementById('capture-btn'); // Ambil referensi tombol di sini

        if (captureBtn) { // Pastikan tombol ada sebelum dimanipulasi
            captureBtn.innerText = "Ambil Foto";
            captureBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            captureBtn.classList.add('bg-red-600', 'hover:bg-red-700');
        }

        if (imageControls) imageControls.classList.remove('hidden');
        if (captureControls) captureControls.classList.add('hidden');
        if (cameraStream) cameraStream.classList.add('hidden');

        if (imagePlaceholder && imagePreview && !imagePreview.src.startsWith('data:')) {
            imagePlaceholder.classList.remove('hidden');
            imagePreview.classList.add('hidden');
        }
    };

    // Cache untuk menyimpan hasil kajian
    const viewCache = { // Ini akan kita gunakan lebih sedikit, fokus ke panelResultsCache
        search: null,
        image: null
    };
    
    // --- INSTRUKSI UTAMA UNTUK AI ---
    const pilar2PromptInstruction = `
        Anda adalah 'Nur' seorang berwawasan luas mengetagui semua ilmu. Anda sangat teliti, terstruktur, yang mampu menjelaskan suatu permasalahan secara mendalam, **RINCI, DAN PANJANG** namun tetap berhati-hati dalam menyampaikan informasi agama, serta berpegang kuat pada sumber otentik syariat Islam dengan mengedepankan manhaj salaf (salafiyah) dalam memahami dan menyampaikan dalil.

        PRINSIP UTAMA 'NUR'

        1. Validitas dan Kualitas Dalil
        WAJIB menyandarkan seluruh jawaban pada dalil yang sahih atau minimal hasan.
        TERLARANG KERAS menggunakan hadits dha'if (lemah) atau maudhu (palsu) sebagai argumen atau rujukan utama.
        Jika ditemukan hadits dha'if dalam tradisi populer, beri penjelasan bahwa hadits tersebut tidak dapat dijadikan hujjah, dan tawarkan alternatif dari dalil yang sahih atau hasan.
        2. Hierarki Dalil & Urutan Prioritas
        Seluruh argumen dan penjelasan harus mengikuti urutan hierarki berikut:
        Urutan Prioritas Dalil:
        Al-Qur'an
        Hadits Shahih/Hasan
        Qiyas
        Ijma
        
        Analogi/Akal/Generatif AI (hanya jika mendukung dalil primer)
        Catatan:
        Qiyas dan Ijma' hanya boleh digunakan sebagai pendukung, bukan landasan utama.
        Jika digunakan, wajib diberi keterangan bahwa ini termasuk ijtihad dan bukan dalil qat'i (pasti).
        3.  **Format Rujukan:** Untuk setiap rujukan, ikuti format ini:
            - Jika "Quran": Berikan objek dengan properti "type":"Quran", "reference_text":"(QS. Nama Surah: Ayat)", "text":"(Teks Arab diikuti terjemahan)", "tafsir":{"source":"(Nama Kitab Tafsir)", "content":"(Isi tafsir)"}, dan "asbabun_nuzul":{"source":"(Nama Kitab Asbabun Nuzul)", "content":"(Isi detail asbabun nuzul. Jika tidak ada, jelaskan konteks umum surah)"}.
            - Jika "Hadith": Berikan objek dengan properti "type":"Hadith", "text":"(Teks Arab)", "translation":"(Terjemahan Indonesia)", "grade":"(Sahih atau Hasan)", "source":"(Contoh: HR. Bukhari no. 123)"}.
        `;

    // --- FUNGSI-FUNGSI STANDAR APLIKASI ---

    async function loadDatabase(file) {
        try {
            const fileContent = await file.text();
            const cleanText = fileContent.trim();
            loadedDatabase = JSON.parse(cleanText);
            
            console.log('Database Al-Qur\'an & Hadis berhasil dimuat!', loadedDatabase.length, 'entri.');
            document.getElementById('main-nav').classList.remove('db-unloaded'); // <-- CUKUP TAMBAHKAN INI

        } catch (error) {
            console.error('Error loading or parsing database:', error);
            throw new Error('Gagal memuat atau mem-parsing database. Pastikan file adalah JSON yang valid.');
        }
    }

    function showLoading(message, targetId = 'results-container') {
        const container = document.getElementById(targetId);
        if (container) {
            // Kita tidak lagi mengosongkan viewCache di sini karena kita ingin hasilnya tetap ada
            // const activeView = document.querySelector('.nav-item.active')?.dataset.view;
            // if (activeView && viewCache.hasOwnProperty(activeView)) {
            //     viewCache[activeView] = null;
            // }
            container.innerHTML = `<div class="flex flex-col justify-center items-center p-8 text-center"><svg class="animate-spin h-12 w-12 text-emerald-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-lg text-gray-400">${message}</p></div>`;
        }
    }

    function showError(message, targetId = 'results-container') {
        const container = document.getElementById(targetId);
        if (container) {
            container.innerHTML = `<div class="bg-red-900/50 text-red-300 p-4 rounded-lg border border-red-700 text-center"><h3 class="font-bold">Terjadi Kesalahan</h3><p>${message}</p></div>`;
        }
    }

    async function callGeminiAPI(payload, retries = 3, delay = 1000) {
        const apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) throw new Error("API Key Gemini belum disimpan. Silakan masukkan di panel Pengaturan.");
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error(`API Error Response (Attempt ${i + 1}/${retries}):`, errorBody);

                    if ((response.status === 503 || response.status === 429) && i < retries - 1) {
                        console.log(`Retrying in ${delay / 1000} seconds...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        continue;
                    } else {
                        throw new Error(`Terjadi masalah saat menghubungi API (Error ${response.status}). Cek API Key Anda atau coba lagi nanti.`);
                    }
                }

                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    try {
                        const rawText = result.candidates[0].content.parts[0].text;
                        const cleanText = rawText.replace(/^```json\s*|```$/g, '');
                        return JSON.parse(cleanText);
                    } catch (e) {
                        console.error("Gagal mem-parsing JSON dari respons Gemini:", e, "Raw Text:", result.candidates[0].content.parts[0].text);
                        throw new Error("Gemini memberikan respons yang tidak valid (bukan format JSON).");
                    }
                } else {
                    console.error("Unexpected API response structure:", result);
                    throw new Error("Struktur respons dari API tidak terduga.");
                }
            } catch (error) {
                if (i === retries - 1 || !(error instanceof TypeError) && !(error.message.includes('Failed to fetch'))) {
                    throw error;
                }
                console.error(`Network or unexpected error (Attempt ${i + 1}/${retries}):`, error);
                console.log(`Retrying in ${delay / 1000} seconds...`);
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
        }
        throw new Error("Gagal menghubungi API Gemini setelah beberapa kali percobaan. Silakan coba lagi nanti.");
    }

    async function exportResultToPDF() {
    const exportButton = document.getElementById('export-btn');
    const contentToExport = document.getElementById('exportable-content');

    if (!contentToExport) {
        showError("Tidak ada konten untuk diekspor.");
        return;
    }
    if (typeof jspdf === 'undefined' || typeof html2canvas === 'undefined') {
        showError("Library PDF belum termuat, coba lagi sesaat.");
        return;
    }

    if (exportButton) {
        exportButton.disabled = true;
        exportButton.innerHTML = 'Mengekspor...';
    }

    // Buka semua elemen <details> agar kontennya terlihat
    const detailsElements = contentToExport.querySelectorAll('details');
    const originalStates = [];
    detailsElements.forEach(details => {
        originalStates.push(details.open);
        details.open = true;
    });

    // Beri sedikit waktu agar browser selesai merender konten yang baru dibuka
    await new Promise(resolve => setTimeout(resolve, 200));

    try {
        // [PERUBAHAN UTAMA] Memberi tahu html2canvas ukuran eksplisit
        const canvas = await html2canvas(contentToExport, {
            scale: 2,
            backgroundColor: '#1f2937',
            width: contentToExport.scrollWidth,
            height: contentToExport.scrollHeight,
            windowWidth: contentToExport.scrollWidth,
            windowHeight: contentToExport.scrollHeight
        });

        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgProps = pdf.getImageProperties(imgData);
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        let heightLeft = imgHeight;
        let position = 0;

        // Tambahkan halaman pertama
        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
        heightLeft -= pdfHeight;

        // Tambahkan halaman berikutnya jika konten lebih panjang dari satu halaman
        while (heightLeft > 0) {
            position = position - pdfHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;
        }

        const today = new Date().toISOString().slice(0, 10);
        pdf.save(`Kajian-Nur-${today}.pdf`);

    } catch (error) {
        console.error("Gagal ekspor ke PDF:", error);
        showError("Terjadi kesalahan saat membuat file PDF.");
    } finally {
        // Kembalikan tombol dan elemen <details> ke kondisi semula
        if (exportButton) {
            exportButton.disabled = false;
            exportButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>`;
        }
        detailsElements.forEach((details, index) => {
            details.open = originalStates[index];
        });
    }
}

    function getHadithBadge(grade) {
        if (!grade) return '';
        grade = grade.toLowerCase();
        if (grade === 'sahih') return `<span class="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">Sahih</span>`;
        if (grade === 'hasan') return `<span class="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200">Hasan</span>`;
        return '';
    }

    const escapeHtml = (text) => {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
};

    function renderMadhhabAnalysis(originalTopic) {
        const madhhabs = ['Hanafi', 'Maliki', 'Syafi\'i', 'Hanbali'];
        let buttonsHtml = madhhabs.map(m => `<button class="madhhab-btn text-left text-sm bg-gray-700 hover:bg-gray-600 text-emerald-300 px-4 py-2 rounded-lg transition-colors" data-madhhab="${m}">${m}</button>`).join('');
        buttonsHtml += `<button class="compare-all-btn text-left text-sm bg-teal-700 hover:bg-teal-600 text-white font-bold px-4 py-2 rounded-lg transition-colors">Bandingkan Semua</button>`;
        return `<div class="mt-8 pt-6 border-t border-gray-700" data-original-topic="${originalTopic}"><h3 class="text-lg font-semibold text-white mb-4">Analisa Lintas Mazhab</h3><div class="flex flex-wrap gap-3">${buttonsHtml}</div></div>`;
    }

    function renderFollowUpQuestions(questions) {
        if (!questions || questions.length === 0) return '';
        const buttonsHtml = questions.map(q => `<button class="follow-up-btn text-left text-sm bg-gray-700 hover:bg-gray-600 text-emerald-300 px-4 py-2 rounded-lg transition-colors" data-followup-query="${q}">${q}</button>`).join('');
        const customQuestionForm = `<form class="custom-follow-up-form mt-4 flex gap-2"><input type="text" placeholder="Ajukan pertanyaanmu sendiri..." class="flex-grow px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"><button type="submit" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors">ASK</button></form>`;
        return `<div class="mt-8 pt-6 border-t border-gray-700"><h3 class="text-lg font-semibold text-white mb-4">Lanjutkan Diskusi:</h3><div class="flex flex-wrap gap-3">${buttonsHtml}</div>${customQuestionForm}</div>`;
    }

    function renderReferensi(references) {
        if (!references || references.length === 0) return '';
        const quranRefs = references.filter(ref => ref.type && ref.type.toLowerCase() === 'quran');
        const hadithRefs = references.filter(ref => ref.type && ref.type.toLowerCase() === 'hadith');
        let referencesHtml = '';

        if (quranRefs.length > 0) {
            referencesHtml += `<h3 class="text-xl font-semibold text-white border-b-2 border-emerald-500/50 pb-2 mb-4">Rujukan Al-Qur'an</h3>`;
            quranRefs.forEach(ref => {
                const tafsirHtml = (ref.tafsir && ref.tafsir.content) ? `<details class="mt-3"><summary>Tafsir (dari ${ref.tafsir.source || 'sumber terpercaya'})</summary><div><p class="text-gray-300 whitespace-pre-wrap">${ref.tafsir.content}</p></div></details>` : '';
                const asbabHtml = (ref.asbabun_nuzul && ref.asbabun_nuzul.content) ? `<details class="mt-2"><summary>Asbabun Nuzul (dari ${ref.asbabun_nuzul.source || 'sumber terpercaya'})</summary><div><p class="text-gray-300 whitespace-pre-wrap">${ref.asbabun_nuzul.content}</p></div></details>` : '';
                referencesHtml += `<div class="bg-gray-900 p-4 rounded-md border-l-4 border-green-500 mb-4">
                                <div class="flex items-center mb-2"><span class="inline-block px-2 py-1 text-xs font-bold rounded bg-green-500/20 text-green-300">Quran</span>${ref.source ? `<span class="ml-2 text-xs font-semibold text-gray-400">${ref.source}</span>` : ''}</div>
                                <p class="text-gray-300 text-right whitespace-pre-wrap text-xl font-arabic mb-2">${ref.text || ''}</p>
                                <p class="text-gray-400 italic whitespace-pre-wrap text-sm">"${ref.translation || ''}"</p>
                                ${tafsirHtml}${asbabHtml}</div>`;
            });
        }

        if (hadithRefs.length > 0) {
            const totalHadithPages = Math.ceil(hadithRefs.length / REFERENCES_PER_PAGE_HADITH);
            const startIdx = currentReferencePage * REFERENCES_PER_PAGE_HADITH;
            const endIdx = startIdx + REFERENCES_PER_PAGE_HADITH;
            const hadithsToShow = hadithRefs.slice(startIdx, endIdx);
            referencesHtml += `<h3 class="text-xl font-semibold text-white border-b-2 border-emerald-500/50 pb-2 mt-6 mb-4">Rujukan Hadis</h3>`;
            hadithsToShow.forEach(ref => {
                const badge = getHadithBadge(ref.grade);
                // Menggunakan fungsi escapeHtml untuk memastikan teks Hadis dirender dengan benar
                const escapedArabicText = escapeHtml(ref.text || '');
                const escapedTranslationText = escapeHtml(ref.translation || '');
                const escapedSourceText = escapeHtml(ref.source || ''); // Juga escape source

                referencesHtml += `<div class="bg-gray-900 p-4 rounded-md border-l-4 border-yellow-500 mb-4">
                                <div class="flex items-center mb-2"><span class="inline-block px-2 py-1 text-xs font-bold rounded bg-yellow-500/20 text-yellow-300">Hadith</span>${badge}</div>
                                <p class="text-gray-300 text-right whitespace-pre-wrap mb-2 font-arabic">${escapedArabicText}</p>
                                <p class="text-gray-400 italic whitespace-pre-wrap">"${escapedTranslationText}"</p>
                                <p class="text-right text-xs text-gray-500 mt-2">${escapedSourceText}</p></div>`;
            });
            
            if (totalHadithPages > 1) {
                referencesHtml += `<div class="flex justify-center items-center space-x-4 mt-4">`;
                if (currentReferencePage > 0) {
                    referencesHtml += `<button class="pagination-btn px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors" data-direction="prev">&lt; Prev</button>`;
                }
                referencesHtml += `<span class="text-gray-400">Halaman ${currentReferencePage + 1} dari ${totalHadithPages}</span>`;
                if (currentReferencePage < totalHadithPages - 1) {
                    referencesHtml += `<button class="pagination-btn px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors" data-direction="next">Next &gt;</button>`;
                }
                referencesHtml += `</div>`;
            }
        }
        return referencesHtml;
    }

    function renderSearchResults(data, status = 'verified') {
    console.log("DEBUG: Data yang diterima renderSearchResults:", data);

    // START PERBAIKAN [OBJECT OBJECT] DI SINI
    let displaySummary = data.summary;
    if (typeof data.summary !== 'string') {
        console.warn("WARN: data.summary bukan string, mencoba JSON.stringify:", data.summary);
        // Konversi objek menjadi string JSON yang diformat. Ini akan terlihat sebagai JSON mentah jika bukan string.
        displaySummary = JSON.stringify(data.summary, null, 2); 
    }

    let displayReferences = data.references;
    // Kita perlu memastikan setiap item di references adalah objek yang benar dan memiliki properti yang diharapkan.
    if (Array.isArray(data.references)) {
        displayReferences = data.references.map(ref => {
            // Jika elemen referensi itu sendiri bukan objek atau null, coba konversi ke string dalam objek sederhana.
            if (typeof ref !== 'object' || ref === null) {
                console.warn("WARN: Item referensi bukan objek/null, mencoba konversi:", ref);
                // Buat objek default agar tidak error saat diakses di renderReferensi
                return { type: "Unknown", text_arabic: "", text_translation: JSON.stringify(ref), source: "Parsed Error" };
            }
            // Jika itu objek, pastikan properti yang dibutuhkan renderReferensi ada, gunakan fallback jika tidak ada.
            return {
                id: ref.id || null,
                type: ref.type || "Unknown",
                source: ref.source || ref.reference_text || "", // Tambahkan ref.reference_text sebagai fallback untuk Quran
                text: ref.text || ref.text_arabic || "", // Ini untuk Al-Qur'an (text) atau Hadis (text_arabic)
                translation: ref.translation || ref.text_translation || "", // Ini untuk Al-Qur'an (translation) atau Hadis (text_translation)
                grade: ref.grade || "", // Untuk Hadis
                tafsir: ref.tafsir || null, // Untuk Al-Qur'an
                asbabun_nuzul: ref.asbabun_nuzul || null // Untuk Al-Qur'an
            };
        });
    } else {
        console.warn("WARN: data.references bukan array, mencoba konversi:", data.references);
        // Jika data.references bukan array, buat array kosong atau array dengan stringified data
        displayReferences = [];
        if (data.references) { // Jika ada isinya tapi bukan array
            displayReferences.push({ type: "Error", text_translation: JSON.stringify(data.references), source: "API Format Error" });
        }
    }
    // END PERBAIKAN [OBJECT OBJECT] DI SINI

    const resultsContainer = document.getElementById('results-container');
    if (!resultsContainer) return;

    // PENTING: Gunakan displayReferences yang sudah diproses di sini
    currentReferences = displayReferences || []; 
    currentReferencePage = 0;
    const referensiHtml = renderReferensi(currentReferences); // Render dengan yang sudah diproses
    const madhhabHtml = renderMadhhabAnalysis(data.query);
    const followUpHtml = renderFollowUpQuestions(data.follow_up_questions);
    let borderColorClass = '';
    let statusLabel = '';
    let statusIcon = '';
    if (status === 'verified') {
        borderColorClass = 'border-green-700';
        statusLabel = 'Terverifikasi dari Sumber Primer (Al-Qur\'an & Hadis)';
        statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
    } else if (status === 'generative') {
        borderColorClass = 'border-yellow-600';
        statusLabel = 'Analisis Generatif oleh AI (Membutuhkan Verifikasi Ahli & Dalil Utama)';
        statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
    }
    const resultHTML = `<div class="bg-gray-800/50 p-8 rounded-lg border ${borderColorClass} animate-fade-in">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-grow">
                                        <h2 class="text-2xl font-bold text-white">Hasil Analisa: <span class="text-emerald-400">${data.query}</span></h2>
                                        <div class="flex items-center text-sm font-semibold mt-2 text-gray-400">
                                            ${statusIcon}
                                            <span>${statusLabel}</span>
                                         </div>
                                    </div>
                                    <button id="export-btn" class="flex-shrink-0 ml-4 px-3 py-2 text-sm bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg transition-colors flex items-center">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                        <span>PDF</span>
                                    </button>
                                </div>
                                <div id="exportable-content">
                                    <p class="text-gray-300 mb-6 whitespace-pre-wrap text-justify">${displaySummary}</p> 
                                    <div id="references-wrapper">${referensiHtml}</div>
                                </div>
                                ${madhhabHtml}
                                ${followUpHtml}
                            </div>`;
    resultsContainer.innerHTML = resultHTML;
    panelResultsCache['unified-search'] = resultsContainer.innerHTML;
}

    function renderImageAnalysis(data, imageSrc) {
        const resultsContainer = document.getElementById('results-container');
        if (!resultsContainer) return;
        const referensiHtml = renderReferensi(data.references);
        const followUpHtml = renderFollowUpQuestions(data.follow_up_questions);
        const resultHTML = `<div class="bg-gray-800/50 p-8 rounded-lg border border-gray-700 animate-fade-in w-full max-w-full">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex-grow">
                                            <h2 class="text-2xl font-bold text-white flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                <span>Tafsir & Hikmah Visual</span>
                                            </h2>
                                        </div>
                                        <button id="export-btn" class="flex-shrink-0 ml-4 px-3 py-2 text-sm bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg transition-colors flex items-center">
                                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                            <span>PDF</span>
                                        </button>
                                    </div>
                                    <div id="exportable-content">
                                        <div class="grid grid-cols-1 gap-8">
                                            <div class="space-y-4">
                                                <div>
                                                    <h3 class="text-lg font-semibold text-emerald-400">Deskripsi Gambar</h3>
                                                    <p class="text-gray-300 whitespace-pre-wrap text-sm leading-relaxed text-justify">${data.description}</p>
                                                </div>
                                                <div>
                                                    <h3 class="text-lg font-semibold text-emerald-400">Pelajaran & Hikmah</h3>
                                                    <p class="text-gray-300 whitespace-pre-wrap text-sm leading-relaxed text-justify">${data.wisdom}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-8">${referensiHtml}</div>
                                    </div>
                                    ${followUpHtml}
                                </div>`;
        // viewCache.image = resultHTML; // Ini tidak lagi diperlukan
        resultsContainer.innerHTML = resultHTML;
        panelResultsCache['image'] = resultsContainer.innerHTML; // Simpan hasil ke cache
    }

    function processQuery(userInput) {
        runQuickAnswerRAG(userInput);
    }

    async function runQuickAnswerRAG(query) {
        const resultsContainer = document.getElementById('results-container');
        if (!resultsContainer) return;

        showLoading('Mencari ilmu dan rujukan lengkap dari Al-Qur\'an dan Hadis...Mohon menunggu', 'results-container');
        resultsContainer.scrollIntoView({ behavior: 'smooth' });

        setTimeout(async () => {
            const searchQuran = document.getElementById('filter-quran')?.checked ?? true;
            const searchHadith = document.getElementById('filter-hadith')?.checked ?? true;

            if (!searchQuran && !searchHadith) {
                showError("Anda harus memilih minimal satu sumber rujukan (Al-Qur'an atau Hadis) untuk melakukan pencarian.");
                return;
            }

            const relevantDocuments = await findRelevantDocuments(query, 15, { searchQuran, searchHadith });

            let contextText = "";
            let referenceObjects = [];

            if (relevantDocuments.length > 0) {
                relevantDocuments.forEach(doc => {
                    if (doc.type === 'Quran') {
                        contextText += `[Qur'an] ${doc.source}: "${doc.translation}"\n`;
                        referenceObjects.push({
                            type: "Quran",
                            reference_text: doc.source,
                            text: doc.text,
                            translation: doc.translation,
                            tafsir: doc.tafsir || null,
                            asbabun_nuzul: doc.asbabun_nuzul || null
                        });
                    } else if (doc.type === 'Hadith') {
                        contextText += `[Hadis] ${doc.source}: "${doc.translation}" (Grade: ${doc.grade || 'Tidak diketahui'})\n`;
                        referenceObjects.push({
                            type: "Hadith",
                            text: doc.text,
                            translation: doc.translation,
                            grade: doc.grade || "Tidak diketahui",
                            source: doc.source
                        });
                    }
                });
            }

            let promptContextSection = "";
            if (contextText) {
                promptContextSection = `
        **KONTEKS RUJUKAN PRIMER DARI DATABASE LOKAL (AL-QUR'AN & HADIS):**
        ${contextText}
        `;
            }

            const prompt = `${pilar2PromptInstruction}
                ${promptContextSection}
                **INSTRUKSI JAWABAN:**
            Sebagai 'Nur', berikan sebuah analisis **LENGKAP** mengenai topik: "${query}" (MAKSIMAL 300 KATA)**.
            Fokus pada **poin-poin pembahasan utama** saja. Gunakan format sub-judul singkat jika perlu.
            --- STRUKTUR ANALISIS WAJIB ---
            Setiap jawaban WAJIB dipecah ke dalam **minimal 3 bagian analisis** di bawah ini untuk memberikan pemahaman yang holistik. Jangan hanya memberikan ringkasan umum.

            1.  **Analisis Kontekstual & Implementasi Praktis:**
                * Jelaskan konsep dasar topik tersebut 
                * Bagaimana implementasinya di dunia nyata dan apa saja contoh-contoh praktisnya?
                * Bagaimana hukum syariat (fiqh) memandang implementasi ini?

            2.  **Analisis Dampak & Etika (Sosial & Kejiwaan):**
                * Apa dampak positif dan negatif dari topik ini terhadap individu dan masyarakat? (misal: efisiensi vs. kehilangan pekerjaan, transparansi vs. privasi).
                * Bagaimana pengaruhnya terhadap pola pikir dan perilaku manusia?
                * Bagaimana adab dan etika Islam seharusnya membingkai penggunaan teknologi atau konsep ini?

            3.  **Analisis Filosofis & Maqashid Syariah (Spiritual):**
                * Hubungkan topik ini dengan tujuan-tujuan utama syariat Islam (**Maqashid al-Shari'ah**), seperti menjaga harta (*hifdz al-mal*), menjaga akal (*hifdz al-'aql*), dan menegakkan keadilan (*'adl*).
                * Apa hikmah atau pelajaran mendalam yang bisa diambil dari inovasi ini?
                * Bagaimana seorang Muslim seharusnya menyikapi topik ini agar selaras dengan nilai-nilai tauhid dan spiritualitas?

            Struktur jawaban Anda HARUS mengikuti poin-poin analisis ini.
            
            PENTING: Untuk setiap rujukan Al-Qur'an yang kamu kutip, CARI dan SERTAKAN TAFSIR dan ASBABUN NUZUL dari pengetahuanmu yang luas.
            
            Berikan jawaban dalam format JSON: {"query": string, "summary": string, "references": [/* MAKSIMAL 4 DALIL PALING RELEVAN DARI KONTEKS PRIMER YANG DISEDIAKAN, SESUAI FORMAT DI ATAS */], "follow_up_questions": [string, string, string]}
            `;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };

            try {
                const resultData = await callGeminiAPI(payload);

                if (referenceObjects.length > 0) {
                    if (resultData.references && Array.isArray(resultData.references)) {
                        resultData.references.forEach(aiRef => {
                            if (aiRef && aiRef.reference_text) {
                                const localRef = referenceObjects.find(lr =>
                                    lr.reference_text && lr.reference_text.includes(aiRef.reference_text.split(':')[0])
                                );
                                if (localRef) {
                                    if (aiRef.tafsir) localRef.tafsir = aiRef.tafsir;
                                    if (aiRef.asbabun_nuzul) localRef.asbabun_nuzul = aiRef.asbabun_nuzul;
                                }
                            }
                        });
                    }
                    resultData.references = referenceObjects;
                    console.log("DEBUG: resultData.references AFTER local DB override:", resultData.references); // TAMBAH INI
                    renderSearchResults(resultData, 'verified');
                } else {
                    console.log("DEBUG: No relevant documents found from local DB, using generative output.", resultData.references); // Tambah ini juga untuk kejelasan
                    renderSearchResults(resultData, 'generative');
                }

            } catch (error) {
                showError(error.message, 'results-container');
            }
        }, 0);
    }
    async function findRelevantDocuments(query, limit = 20, options = { searchQuran: true, searchHadith: true }) {
        const allFoundDocs = [];
        const lowerCaseQuery = query.toLowerCase().trim();
        const { searchQuran, searchHadith } = options;
        const stopWords = new Set([
    'adalah', 'adanya', 'adapun', 'agak', 'agar', 'akan', 'aku', 'akulah', 'amat', 'antara', 'antaranya', 'apabila', 'apakah', 'apaan', 'atas', 'atau', 'ataupun',
    'bagai', 'bagaikan', 'bagaimana', 'bagi', 'bahkan', 'bahwa', 'banyak', 'beberapa', 'belum', 'berada', 'berbagai', 'berdasarkan', 'berapa', 'berasal', 'berarti',
    'berikut', 'berikutnya', 'bersama', 'bersama-sama', 'besar', 'betulkah', 'bisa', 'boleh', 'bukan', 'bukankah', 'bukanlah',
    'cukup',
    'dari', 'daripada', 'demikian', 'demikianlah', 'dengan', 'depan', 'di', 'dia', 'dialah', 'dll', 'dsb',
    'guna',
    'harus', 'hendak', 'hendaklah', 'hingga',
    'ia', 'ialah', 'ibarat', 'ini', 'inilah', 'itu', 'itulah',
    'jangan', 'jika', 'juga', 'justru',
    'kala', 'kalau', 'kami', 'kamilah', 'kamu', 'karena', 'karenanya', 'ke', 'kecuali', 'keluar', 'kembali', 'kemudian', 'kepadanya', 'keterangan', 'kini', 'kira-kira', 'kita', 'kitalah',
    'kurang',
    'lagi', 'lagian', 'lalu', 'lain', 'lainnya', 'lepas', 'lebih',
    'maka', 'makanya', 'mana', 'manakala', 'masih', 'mau', 'maupun', 'melainkan', 'memang', 'mengenai', 'menurut', 'mereka', 'merekalah', 'mungkin', 'mustahil',
    'nah', 'namun',
    'oleh', 'olehnya',
    'pada', 'padahal', 'paling', 'para', 'pasti', 'pun',
    'saat', 'saja', 'saling', 'sama', 'sama-sama', 'sampai', 'sana', 'sangat', 'sangatlah', 'saya', 'sayalah', 'sebab', 'sebabnya', 'sebagai', 'sebagaimana', 'sebagian',
    'sebelum', 'sebelumnya', 'secara', 'sedang', 'sedangkan', 'sedikit', 'sedikitnya', 'segala', 'sehingga', 'sejak', 'sekali', 'sekalian', 'sekilas', 'sekitar', 'selain',
    'selalu', 'selama', 'selama-lamanya', 'seluruh', 'semata', 'sementara', 'semua', 'semuanya', 'semula', 'sendiri', 'sendirinya', 'seolah', 'seperti', 'sepertinya',
    'sering', 'seringnya', 'serta', 'siapa', 'siapakah', 'siapapun', 'sini', 'suatu', 'sudah', 'sungguh', 'sungguhnya', 'supaya',
    'tahukah', 'tanpa', 'tapi', 'terhadap', 'termasuk', 'tentang', 'tentu', 'terlalu', 'tersebut', 'tetapi', 'tiada', 'tidak', 'tidakkah', 'tidaklah',
    'toh', 'total', 'umum', 'umumnya', 'untuk', 'usah',
    'via',
    'wahai', 'walau', 'walaupun', 'wong',
    'yaitu', 'yakni', 'yang'
]);
        const queryWords = lowerCaseQuery.split(/\s+/).filter(word => word.length > 2 && !stopWords.has(word));

        loadedDatabase.forEach(doc => {
            if (!searchQuran && doc.type === 'Quran') return;
            if (!searchHadith && doc.type === 'Hadith') return;

            let relevanceScore = 0;
            const contentToSearch = ((doc.translation || '') + ' ' + (doc.text || '')).toLowerCase();

            // Skema scoring yang lebih canggih
            // 1. Prioritas tertinggi untuk kecocokan frase lengkap (exact match)
            if (contentToSearch.includes(lowerCaseQuery)) {
                relevanceScore += 2000; // Sangat relevan
            }

            // 2. Bonus untuk Al-Qur'an (jika relevan dengan kata kunci query)
            // Ini akan memastikan Al-Qur'an tetap diprioritaskan jika ada relevansi dasar
            if (doc.type === 'Quran' && queryWords.some(word => contentToSearch.includes(word))) {
                relevanceScore += 1000; // Bonus besar untuk Al-Qur'an yang relevan
            }

            // 3. Skor berdasarkan jumlah kata kunci yang cocok
            if (queryWords.length > 0) {
                let matchedKeywordsCount = 0;
                queryWords.forEach(word => {
                    if (contentToSearch.includes(word)) {
                        matchedKeywordsCount++;
                    }
                });
                relevanceScore += matchedKeywordsCount * 100; // Setiap kata kunci yang cocok bernilai 100
            }

            // Pastikan dokumen memiliki setidaknya beberapa relevansi dasar
            if (relevanceScore === 0 && lowerCaseQuery.length > 2) {
                // Jika tidak ada skor sama sekali tapi query cukup panjang, berikan skor minimal jika ada partial match
                if (queryWords.some(word => contentToSearch.includes(word))) {
                    relevanceScore += 1; // Skor sangat rendah, hanya untuk memastikan masuk daftar
                }
            }

            if (queryWords.length > 0) {
                const allKeywordsFound = queryWords.every(word => contentToSearch.includes(word));

                if (allKeywordsFound) {
                    relevanceScore += (queryWords.length > 1) ? 200 : 100;
                }
            }

            if (relevanceScore >= 100) {
                if (!allFoundDocs.some(found => found.doc.id === doc.id)) {
                    allFoundDocs.push({ doc, score: relevanceScore });
                }
            }
        });

        allFoundDocs.sort((a, b) => b.score - a.score);
        const uniqueRelevantDocs = allFoundDocs.map(item => item.doc);
        console.log(`DEBUG: findRelevantDocuments for "${query}" - Found: ${uniqueRelevantDocs.length} docs (before slice)`);
        console.log("DEBUG: Top 20 relevant documents before slicing:", uniqueRelevantDocs.slice(0, 20)); // Tambahkan baris ini

        return uniqueRelevantDocs.slice(0, limit);
    }

    const panelInitializers = {
        'unified-search': function() {
            const panel = document.getElementById('unified-search-panel');
            if (!panel) return;
            panel.innerHTML = `<form id="unified-search-form" class="relative"><textarea id="unified-search-input" rows="3" placeholder="Ketik (Klik Mic) topik, pertanyaan, atau referensi (misal: QS. Al-Baqarah: 183, HR. Bukhari tentang niat) Pilih Rujukan Al-Qur'an/Hadis atau keduanya" class="w-full p-4 pr-12 bg-gray-800 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea><button type="button" class="dictation-btn absolute top-4 right-4 text-gray-400 hover:text-emerald-400" data-target="unified-search-input"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg></button><button type="submit" class="mt-4 w-full px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition-colors">SEARCH</button><div class="mt-4 flex items-center justify-center space-x-6"><label for="filter-quran" class="flex items-center text-gray-300 cursor-pointer"><input type="checkbox" id="filter-quran" class="form-checkbox h-5 w-5 bg-gray-700 border-gray-600 rounded text-emerald-500 focus:ring-emerald-500" checked><span class="ml-2">Al-Qur'an</span></label><label for="filter-hadith" class="flex items-center text-gray-300 cursor-pointer"><input type="checkbox" id="filter-hadith" class="form-checkbox h-5 w-5 bg-gray-700 border-gray-600 rounded text-emerald-500 focus:ring-emerald-500" checked><span class="ml-2">Hadis</span></label></div></form>`;
            panel.querySelector('#unified-search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const query = panel.querySelector('#unified-search-input').value.trim();
                if (query) processQuery(query);
            
            });
            const searchInput = panel.querySelector('#unified-search-input');
            const searchForm = panel.querySelector('#unified-search-form');

            if (searchInput && searchForm) {
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    searchForm.dispatchEvent(new Event('submit'));
                    }
                });
             }
        },
        image: function() {
            const panel = document.getElementById('image-panel');
            if (!panel) return;
            panel.innerHTML = `<div class="max-w-md mx-auto text-center"><div id="image-display-area" class="mb-4 h-64 bg-gray-800 border-2 border-dashed border-gray-700 rounded-lg flex items-center justify-center overflow-hidden"><p id="image-placeholder" class="text-gray-500">VIEW FINDER</p><img id="image-preview" src="" class="hidden max-h-full max-w-full rounded-lg"/><video id="camera-stream" class="hidden w-full h-full object-cover" autoplay></video></div><canvas id="camera-canvas" class="hidden"></canvas><div id="image-controls" class="space-y-2"><div class="space-y-2"><div class="flex space-x-2"><button id="upload-btn" class="w-full px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition-colors">Upload Gambar</button><button id="camera-btn" class="w-full px-6 py-3 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-lg transition-colors">Photo Capture</button></div><button id="micro-expression-btn" class="w-full px-6 py-2 bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 5.555a1 1 0 00-1.9 1.11l1.018 3.156a.5.5 0 01-.444.679H8a1 1 0 100 2h1.632a.5.5 0 01.444.679l-1.018 3.155a1 1 0 101.9 1.11l1.544-4.78a.5.5 0 010-.222L9.555 5.555z" clip-rule="evenodd" /></svg>Deteksi Ekspresi Mikro (Video)</button></div></div><div id="capture-controls" class="hidden space-y-2"><button id="capture-btn" class="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors">Ambil Foto</button><button id="switch-camera-btn" class="w-full text-sm py-2 text-gray-300 hover:text-white transition-colors">Kamera Belakang</button><button id="cancel-camera-btn" class="w-full text-sm text-gray-400 hover:text-white transition-colors">Batal</button></div><input type="file" id="image-input" class="hidden" accept="image/*"/></div>`;

            const imageInput = panel.querySelector('#image-input'), uploadBtn = panel.querySelector('#upload-btn'), cameraBtn = panel.querySelector('#camera-btn'), imagePreview = panel.querySelector('#image-preview'), imagePlaceholder = panel.querySelector('#image-placeholder'), cameraStream = panel.querySelector('#camera-stream'), cameraCanvas = panel.querySelector('#camera-canvas'), imageControls = panel.querySelector('#image-controls'), captureControls = panel.querySelector('#capture-controls'), captureBtn = panel.querySelector('#capture-btn'), cancelCameraBtn = panel.querySelector('#cancel-camera-btn'), microExpressionBtn = panel.querySelector('#micro-expression-btn'), switchCameraBtn = panel.querySelector('#switch-camera-btn');
            let currentFacingMode = 'user';

            async function startCamera(facingMode) {
                if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); }
                const constraints = { video: { facingMode: { exact: facingMode } } };
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    cameraStream.srcObject = currentStream;
                    imageControls.classList.add('hidden');
                    captureControls.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                    imagePreview.classList.add('hidden');
                    cameraStream.classList.remove('hidden');
                } catch (err) {
                    showError(`Gagal mengakses kamera: ${err.message}. Coba gunakan kamera lain.`);
                    stopCamera();
                }
            }

            const analyzeImage = async (base64Data, mimeType) => {
                showLoading('Menganalisa hasil capture..Mohon SABAR menunggu....');
                document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });

                const tempImageForAnalysis = new Image();
                tempImageForAnalysis.src = `data:${mimeType};base64,${base64Data}`;
                await new Promise(resolve => tempImageForAnalysis.onload = resolve);

                const detections = await faceapi.detectAllFaces(tempImageForAnalysis, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                let prompt;

                if (detections.length > 0) {
                    const expression = Object.keys(detections[0].expressions).reduce((a, b) => detections[0].expressions[a] > detections[0].expressions[b] ? a : b);
                    prompt = `
            ${pilar2PromptInstruction}
            Anda adalah seorang analis visual yang puitis dan bijaksana, mampu membaca makna mendalam dari sebuah gambar. Juga mampu melakukan kalkulasi kemungkinan interaksi yang memnuculkan sebab akibat dari object yang ada dalam gambar. 
            **Konteks Analisa:**
            - Sebuah gambar telah diambil.
            - Hasil deteksi wajah: Ditemukan **${detections.length}** orang.
            - Ekspresi wajah yang paling dominan adalah: **${expression}**.
            
            **Tugas Anda memiliki tiga bagian yang harus dijawab secara berurutan dan lengkap:**
            **1. Deskripsi Visual Sinematik (Untuk Properti 'description'):** Lukiskan gambar ini dengan kata-kata seolah Anda seorang sinematografer. Jelaskan secara detail tentang komposisi gambar, pencahayaan, palet warna, dan tekstur objek penting. Ciptakan sebuah "rasa" atau "mood" dari visual yang ada.
            **2. Interpretasi Karakter & Emosi (Untuk Properti 'wisdom' - Paragraf Pertama):** Berdasarkan semua data visual dari Tugas 1, berikan interpretasi tentang kemungkinan keadaan emosional subjek. Gunakan frasa interpretatif seperti "Ekspresi ini memberikan kesan...", "Postur tubuhnya mungkin menyiratkan...". Analisa interaksi antara subjek dengan lingkungannya. UNTUK DEBUGGING: BOLEH menyampaikan kalimat **DIAGNOSIS KLINIS**.
            **3. Hikmah Kontekstual & Refleksi Diri (Untuk Properti 'wisdom' - Paragraf Kedua):** Hubungkan interpretasi dari Tugas 2 dengan prinsip Islami. Kaitkan dengan tema syukur, sabar, atau muhasabah. Berikan 1-2 pertanyaan reflektif.
            **FORMAT OUTPUT JSON (WAJIB DIPATUHI):**
            {"description": "(Hasil dari Tugas 1)", "wisdom": "(Hasil dari Tugas 2 dan 3, gabungkan menjadi satu teks mengalir)", "references": [/* array objek Al-Qur'an/Hadis */], "follow_up_questions": [/* 2-3 pertanyaan reflektif */]}`;
                } else {
                    prompt = `
            ${pilar2PromptInstruction}
            Analisa gambar berikut dan gali hikmahnya secara mendalam. 
            Tugas Anda:
            1.  **description**: Deskripsikan gambar secara detail, termasuk objek, suasana, dan pencahayaan.
            2.  **wisdom**: Berikan pelajaran atau hikmah yang bisa diambil dari keseluruhan gambar dari sudut pandang Islam.
            3.  **references**: Sertakan rujukan dalil jika relevan.
            Berikan jawaban dalam format JSON: {"description": string, "wisdom": string, "references": [/* array of Quran/Hadith objects */], "follow_up_questions": [string, string, string]}`;
                }

                const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: mimeType, data: base64Data } }] }], generationConfig: { responseMimeType: "application/json" } };
                try {
                    const resultData = await callGeminiAPI(payload);
                    renderImageAnalysis(resultData, `data:${mimeType};base64,${base64Data}`);
                } catch (error) { showError(error.message); }
            };

            uploadBtn.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    imagePreview.src = reader.result;
                    imagePreview.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                    analyzeImage(base64Data, file.type);
                };
                reader.readAsDataURL(file);
            });

            if (hasCameraSupport && isSecureContext) {
                cameraBtn.addEventListener('click', () => {
                    captureBtn.innerText = "Ambil Foto";
                    captureBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    captureBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    captureBtn.onclick = () => {
                        cameraCanvas.width = cameraStream.videoWidth;
                        cameraCanvas.height = cameraStream.videoHeight;
                        cameraCanvas.getContext('2d').drawImage(cameraStream, 0, 0);
                        const imageDataUrl = cameraCanvas.toDataURL('image/jpeg');
                        imagePreview.src = imageDataUrl;
                        imagePreview.classList.remove('hidden');
                        stopCamera();
                        analyzeImage(imageDataUrl.split(',')[1], 'image/jpeg');
                    };
                    startCamera(currentFacingMode);
                });

                microExpressionBtn.addEventListener('click', () => {
                    captureBtn.innerText = "Mulai Analisa";
                    captureBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    captureBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    captureBtn.onclick = () => {
                        if (!isAnalyzingVideo) {
                            isAnalyzingVideo = true;
                            detectedEvents = [];
                            analysisStartTime = Date.now();
                            captureBtn.innerText = "Hasilkan Laporan";
                            captureBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                            captureBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                            analyzeVideoStream();
                        } else {
                            generateMicroExpressionReport();
                        }
                    };
                    startCamera(currentFacingMode);
                });

                switchCameraBtn.addEventListener('click', () => {
                    currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
                    startCamera(currentFacingMode);
                });

            } else {
                cameraBtn.classList.add('secure-feature-disabled');
                microExpressionBtn.classList.add('secure-feature-disabled');
            }

            cancelCameraBtn.addEventListener('click', stopCamera);
        },
        settings: function() {
            const panel = document.getElementById('settings-panel');
            if (!panel) return;
            panel.innerHTML = `
                    <div class="max-w-xl mx-auto p-4 bg-gray-800/50 border border-gray-700 rounded-lg">
                        <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key Anda</label>
                        <div class="flex items-center space-x-2">
                            <input id="api-key-input" type="password" placeholder="Masukkan API Key dari Google AI Studio" class="flex-grow px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"/>
                            <button id="save-api-key-btn" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-md transition-colors">Simpan</button>
                        </div>
                        <p id="api-key-status" class="text-xs text-gray-500 mt-2"></p>
                        <p class="text-center text-xs text-gray-500 mt-3">Tidak punya API Key? Dapatkan di <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-emerald-400 hover:underline">Google AI Studio</a>.</p>
                    </div>

                    <div class="max-w-xl mx-auto p-4 bg-gray-800/50 border border-gray-700 rounded-lg mt-6">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Muat Database Al-Qur'an & Hadis atau bisa tanpa database AI only !!</label>
                        <div class="flex items-center space-x-3 mt-2">
                            <label for="database-file-input" class="w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-md transition-colors cursor-pointer">
                                Pilih File Lokal
                            </label>
                            <input type="file" id="database-file-input" accept=".json" class="hidden"/>
                            <button id="load-from-github-btn" class="w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-md transition-colors">
                                GitHub
                            </button>
                        </div>
                        <p id="database-status" class="text-center text-xs text-gray-500 mt-3">Pilih file lokal atau muat langsung dari GitHub.</p>
                    </div>
                    `;
            const apiKeyInput = panel.querySelector('#api-key-input');
            const saveApiKeyBtn = panel.querySelector('#save-api-key-btn');
            const apiKeyStatus = panel.querySelector('#api-key-status');
            const saveApiKey = () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    apiKeyStatus.textContent = 'API Key berhasil disimpan!';
                    apiKeyStatus.className = 'text-xs text-green-400 mt-2 opacity-100 transition-opacity duration-300';
                } else {
                    localStorage.removeItem('geminiApiKey');
                    apiKeyStatus.textContent = 'API Key dihapus dari penyimpanan.';
                    apiKeyStatus.className = 'text-xs text-yellow-400 mt-2 opacity-100 transition-opacity duration-300';
                }
                setTimeout(() => {
                    if (apiKeyStatus) {
                        apiKeyStatus.classList.remove('opacity-100');
                        apiKeyStatus.classList.add('opacity-0');
                    }
                }, 3000);
            };
            const loadApiKey = () => {
                const savedKey = localStorage.getItem('geminiApiKey');
                if (savedKey) {
                    apiKeyInput.value = savedKey;
                    apiKeyStatus.textContent = 'API Key berhasil dimuat dari penyimpanan browser.';
                    apiKeyStatus.className = 'text-xs text-green-400 mt-2';
                } else {
                    apiKeyStatus.textContent = 'Silakan masukkan Gemini API Key Anda untuk memulai.';
                    apiKeyStatus.className = 'text-xs text-yellow-400 mt-2';
                }
            };
            saveApiKeyBtn.addEventListener('click', saveApiKey);
            loadApiKey();
            const loadFromGithubBtn = panel.querySelector('#load-from-github-btn');
            const dbStatus = panel.querySelector('#database-status');
            if (loadFromGithubBtn) {
                loadFromGithubBtn.addEventListener('click', async () => {
                    const githubUrl = 'https://media.githubusercontent.com/media/opixtm/nur/main/database.json';
                    dbStatus.textContent = 'Mengunduh database dari GitHub, mohon tunggu...';
                    dbStatus.className = 'text-center text-xs text-yellow-400 mt-3';
                    try {
                        const response = await fetch(githubUrl);
                        if (!response.ok) {
                            throw new Error(`Gagal mengunduh: Server merespons dengan status ${response.status}`);
                        }
                        const rawText = await response.text();
                        const cleanText = rawText.trim();
                        const data = JSON.parse(cleanText);
                        loadedDatabase = data;
                        dbStatus.textContent = `Database dari GitHub berhasil dimuat. Total ${loadedDatabase.length} entri.`;
                        dbStatus.className = 'text-center text-xs text-green-400 mt-3';
                        
                        document.getElementById('main-nav').classList.remove('db-unloaded');
                        console.log('Database dari GitHub berhasil dimuat!', loadedDatabase.length, 'entri.');
                    } catch (error) {
                        dbStatus.textContent = `Gagal memuat dari GitHub: ${error.message}`;
                        dbStatus.className = 'text-center text-xs text-red-400 mt-3';
                        console.error('Error loading from GitHub:', error);
                    }
                });
            }
            const databaseFileInput = panel.querySelector('#database-file-input');
            const databaseStatus = panel.querySelector('#database-status');
            if (databaseFileInput) {
                databaseFileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        databaseStatus.textContent = 'Memuat database, mohon tunggu...';
                        databaseStatus.className = 'text-xs text-yellow-400 mt-2';
                        try {
                            await loadDatabase(file);
                            databaseStatus.textContent = `Database "${file.name}" berhasil dimuat. Total ${loadedDatabase.length} entri.`;
                            databaseStatus.className = 'text-xs text-green-400 mt-2';
                        } catch (error) {
                            databaseStatus.textContent = `Gagal memuat database: ${error.message}`;
                            databaseStatus.className = 'text-xs text-red-400 mt-2';
                            console.error('Error loading database:', error);
                        }
                    } else {
                        databaseStatus.textContent = 'Belum ada database dimuat. Pilih file database.json Anda.';
                        databaseStatus.className = 'text-xs text-gray-500 mt-2';
                    }
                });
            }
        },
    };

    const panelInitialized = {};
    function switchView(viewName) {
        // (1) Sembunyikan semua panel dan nonaktifkan semua tombol navigasi
        document.querySelectorAll('.panel').forEach(p => {
            p.classList.remove('panel-active');
            p.style.display = 'none'; // Tambahkan ini jika Anda juga mengelola display CSS
        });
        document.querySelectorAll('.nav-item').forEach(n => {
            n.classList.remove('active');
        });

        // (2) Aktifkan tombol navigasi yang sesuai
        const navButton = document.querySelector(`.nav-item[data-view="${viewName}"]`);
        if (navButton) {
            navButton.classList.add('active');
        }

        // (3) Dapatkan panel yang akan diaktifkan
        const activePanel = document.getElementById(`${viewName}-panel`);
        if (activePanel) {
            // Aktifkan panel (tampilkan dengan kelas panel-active)
            activePanel.classList.add('panel-active');
            activePanel.style.display = 'block'; // Atau 'flex', sesuaikan dengan kebutuhan layout CSS Anda

            // 4. Inisialisasi panel jika belum pernah diinisialisasi
            if (!panelInitialized[viewName]) {
                if (panelInitializers[viewName]) {
                    panelInitializers[viewName]();
                }
                panelInitialized[viewName] = true;
            }

            // 5. Kelola tampilan hasil di results-container
            // Dapatkan elemen results-container utama yang ada di dalam <main>
            const resultsContainer = document.getElementById('results-container');

            if (resultsContainer) { // Pastikan resultsContainer ada
                if (panelResultsCache.hasOwnProperty(viewName) && panelResultsCache[viewName]) {
                    // Jika ada hasil yang tersimpan di panelResultsCache untuk view ini, tampilkan
                    resultsContainer.innerHTML = panelResultsCache[viewName];
                } else {
                    // Jika tidak ada hasil tersimpan, kosongkan resultsContainer
                    resultsContainer.innerHTML = '';
                }
                // Gulir ke atas jika ada konten baru atau di-restore
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        loadFaceApiModels();
        const mainNav = document.getElementById('main-nav');
        if (mainNav) {
            mainNav.addEventListener('click', (e) => {
                const navItem = e.target.closest('.nav-item');
                if (navItem && navItem.dataset.view) {
                    switchView(navItem.dataset.view);
                }
            });
        }
        const resultsContainer = document.getElementById('results-container');
        if (resultsContainer) {
            resultsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.pagination-btn')) {
                    const direction = e.target.dataset.direction;
                    if (direction === 'prev') {
                        currentReferencePage = Math.max(0, currentReferencePage - 1);
                    } else if (direction === 'next') {
                        currentReferencePage++;
                    }
                    const wrapper = document.getElementById('references-wrapper');
                    if (wrapper) {
                        wrapper.innerHTML = renderReferensi(currentReferences);
                    }
                    return;
                }
                const madhhabBtn = e.target.closest('.madhhab-btn');
                if (madhhabBtn) {
                    const madhhab = madhhabBtn.dataset.madhhab;
                    const originalTopic = madhhabBtn.closest('[data-original-topic]').dataset.originalTopic;
                    processQuery(`Jelaskan pandangan Mazhab ${madhhab} tentang ${originalTopic} secara mendalam`);
                    return;
                }
                const compareBtn = e.target.closest('.compare-all-btn');
                if (compareBtn) {
                    const originalTopic = compareBtn.closest('[data-original-topic]').dataset.originalTopic;
                    processQuery(`Buat perbandingan ringkas pandangan 4 mazhab (Hanafi, Maliki, Syafi'i, Hanbali) tentang topik: "${originalTopic}". Sajikan dalam format tabel jika memungkinkan.`);
                    return;
                }
                if (e.target.closest('#export-btn')) {
                    exportResultToPDF();
                    return;
                }
                if (e.target.matches('.follow-up-btn')) {
                    processQuery(e.target.dataset.followupQuery);
                }
            });
            resultsContainer.addEventListener('submit', (e) => {
                if (e.target.matches('.custom-follow-up-form')) {
                    e.preventDefault();
                    const input = e.target.querySelector('input[type="text"]');
                    if (input && input.value) processQuery(input.value.trim());
                }
            });
        }
        if (SpeechRecognition && isSecureContext) {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'id-ID';
            recognition.interimResults = false;
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const targetId = recognition.targetInputId;
                const targetInput = document.getElementById(targetId);
                if (targetInput) targetInput.value = transcript;
            };
            recognition.onerror = (event) => { showError(`Error dikte: ${event.error}`); };
            recognition.onend = () => { document.querySelectorAll('.dictation-btn').forEach(btn => btn.classList.remove('recording')); };
            document.body.addEventListener('click', (e) => {
                if (e.target.matches('.dictation-btn') || e.target.closest('.dictation-btn')) {
                    const btn = e.target.closest('.dictation-btn');
                    recognition.targetInputId = btn.dataset.target;
                    btn.classList.add('recording');
                    recognition.start();
                }
            });
        } else {
            document.querySelectorAll('.dictation-btn').forEach(btn => {
                btn.classList.add('secure-feature-disabled');
                btn.title = "Fitur dikte memerlukan koneksi aman (HTTPS).";
            });
        }
        switchView('unified-search');
    });
</script>
</body>
</html>
