<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensiklopedia Nur v10.1 (Filter Rujukan)</title>
    
    <!-- Tailwind CSS CDN untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Noto Naskh Arabic untuk teks Arab -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">

    <!-- Library untuk Export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- Gaya Responsif Mobile (Perbaikan Tuntas) --- */
        @media (max-width: 768px) {
            /* (1) Buat 'aside' menjadi header yang menempel di atas */
            aside {
                position: sticky;   /* Kunci utama: Buat seluruh blok header menempel */
                top: 0;
                z-index: 1000;      /* Pastikan berada di lapisan paling atas */
                width: 100% !important;
                height: auto !important;
                background-color: #111827; /* Warna solid agar konten tidak tembus (bg-gray-900) */
                padding: 0.75rem 1rem;
                border-bottom: 1px solid #374151; /* Garis pemisah */
                
                /* Reset tata letak internalnya */
                display: block;
                position: static; /* Hapus posisi aneh dari aturan desktop */
            }

            /* (2) Atur ulang posisi judul di dalam header */
            aside .mb-8 {
                margin-bottom: 0.75rem; /* Jarak dari judul ke navigasi */
                text-align: center;
            }

            /* (3) Atur baris navigasi agar bisa scroll ke samping */
            #main-nav {
                display: flex;
                flex-direction: row;
                overflow-x: auto;   /* Aktifkan scroll horizontal */
                justify-content: flex-start; /* Mulai dari kiri */
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Sembunyikan scrollbar */
            }
            #main-nav::-webkit-scrollbar {
                display: none;
            }
            .nav-item {
                flex-shrink: 0;
                white-space: nowrap;
            }

            /* (4) Beri ruang pada konten utama agar tidak tertutup header */
            main {
                margin-left: 0 !important;
                /* Padding atas ini krusial untuk mendorong konten ke bawah header */
                padding-top: 1rem;
            }

            /* (5) Atur ulang tata letak spesifik lainnya */
            #pillar-container, #exportable-content .grid {
                grid-template-columns: 1fr; /* Paksa jadi satu kolom */
            }
        }
        /* --- Gaya Umum --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; /* bg-gray-900 */
            color: #e5e7eb; /* text-gray-200 */
            scroll-behavior: smooth; 
        }
        /* Font khusus untuk teks Arab */
        .font-arabic {
            font-family: 'Noto Naskh Arabic', serif;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        
        /* --- Navigasi Sidebar --- */
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            color: #9ca3af;
        }
        .nav-item:hover {
            background-color: #1f2937; /* bg-gray-800 */
            color: #f9fafb; /* text-gray-50 */
        }
        .nav-item.active {
            background-color: #059669; /* bg-emerald-600 */
            color: #ffffff;
            font-weight: 600;
        }
        .nav-item svg {
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
        }

        /* --- Visibilitas Panel --- */
        .panel { display: none; }
        .panel-active { display: block; }
        
        /* --- Gaya Spesifik Fitur --- */
        .dictation-btn.recording svg {
            color: #ef4444; /* text-red-500 */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .secure-feature-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .group-btn {
            background-color: #374151; /* bg-gray-700 */
            transition: background-color 0.2s;
            width: 100%;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
        }
        .group-btn:hover {
            background-color: #4b5563; /* bg-gray-600 */
        }
        .pillar-item {
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
        }
        .pillar-item:hover {
            background-color: #374151; /* bg-gray-700 */
            color: #10b981; /* text-emerald-500 */
        }

        /* Gaya untuk Accordion Tafsir & Asbabun Nuzul */
        details summary {
            cursor: pointer;
            font-weight: 600;
            color: #34d399; /* emerald-400 */
            transition: color 0.2s;
            list-style: none; /* Hapus panah default */
            display: flex;
            align-items: center;
        }
        details summary::-webkit-details-marker {
            display: none; /* Hapus panah di Chrome/Safari */
        }
        details summary:hover {
            color: #6ee7b7; /* emerald-300 */
        }
        details summary::before {
            content: 'â–º';
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        details > div {
            padding: 0.75rem;
            margin-top: 0.5rem;
            background-color: #1f2937; /* bg-gray-800 */
            border-left: 2px solid #10b981; /* border-emerald-500 */
            border-radius: 0 0.375rem 0.375rem 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="flex h-screen">
        <aside class="w-64 bg-gray-800/50 p-4 flex flex-col fixed h-full overflow-y-auto">
            <div class="mb-8 text-center">
                <h1 class="text-2xl font-bold text-white">Ensiklopedia Nur</h1>
                <p class="text-sm text-emerald-400">v10.1 (Filter Rujukan)</p>
            </div>
            <nav id="main-nav" class="flex-grow space-y-2">
                <button class="nav-item active" data-view="unified-search"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>Pencarian & Riset</button>
                <button class="nav-item" data-view="image"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>Hikmah Gambar</button>
                <button class="nav-item" data-view="settings"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.57 6.57 0 01-.22.127c-.332.183-.582.495-.645.87l-.213 1.281c-.09.542-.56.94-1.11-.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.003-.827c.293.24.438.613-.438.995s-.145-.755-.438-.995l-1.003-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37.49l1.217.456c.355.133.75.072 1.075-.124.072-.044.146-.087.22-.127.332-.183.582.495.645-.87l.213-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>Pengaturan</button>
            </nav>
        </aside>

        <main class="ml-64 flex-1 p-8 overflow-y-auto">
            <div id="dashboard-panel" class="panel panel-active"></div>
            <div id="unified-search-panel" class="panel"></div>
            <div id="image-panel" class="panel"></div>
            <div id="settings-panel" class="panel"></div>
            
            <div id="results-container" class="w-full mx-auto mt-8"></div>
        </main>
    </div>

    <script>
        // --- DATA STATIS ---
        const rukunIslam = ["Syahadat", "Shalat", "Puasa", "Zakat", "Haji"];
        const rukunIman = ["Iman kepada Allah", "Iman kepada Malaikat", "Iman kepada Kitab", "Iman kepada Rasul", "Iman kepada Hari Akhir", "Iman kepada Qada & Qadar"];
        
        // --- VARIABEL GLOBAL & KONTROL KEAMANAN ---
        const isSecureContext = window.isSecureContext;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const hasCameraSupport = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
        let currentStream;
        let loadedDatabase = []; // Variabel untuk menyimpan data Qur'an dan Hadis dari database.json
        let currentReferences = []; // Menyimpan semua rujukan yang ditemukan untuk pagination
        let currentReferencePage = 0; // Halaman rujukan saat ini
        const REFERENCES_PER_PAGE_QURAN = 10;
        const REFERENCES_PER_PAGE_HADITH = 5;

        // Fungsi untuk memuat dan mem-parsing database.json
        async function loadDatabase(file) {
            try {
                const fileContent = await file.text();
                // Membersihkan teks dari karakter tak terlihat (BOM) sebelum parsing
                const cleanText = fileContent.trim();
                loadedDatabase = JSON.parse(cleanText);
                console.log('Database Al-Qur\'an & Hadis berhasil dimuat!', loadedDatabase.length, 'entri.');
            } catch (error) {
                console.error('Error loading or parsing database:', error);
                throw new Error('Gagal memuat atau mem-parsing database. Pastikan file adalah JSON yang valid.');
            }
        }

        // Cache untuk menyimpan hasil kajian
        const viewCache = {
            search: null,
            image: null
        };

        // Instruksi utama untuk Pilar 2 (Validitas & Hierarki Rujukan)
        const pilar2PromptInstruction = `
        Anda adalah seorang cendekiawan Muslim 'Nur' yang sangat teliti, berpegang teguh pada sumber otentik, dan memahami hierarki dalil.
        PRINSIP UTAMA ANDA:
        1.  **Validitas Sumber:** Setiap jawaban HARUS bersumber dari Al-Qur'an dan Hadits yang minimal berderajat Hasan. DILARANG KERAS menggunakan hadits Dha'if (lemah) atau Maudhu' (palsu) sebagai landasan argumen.
        2.  **Hierarki Dalil & Prioritas Rujukan:** Prioritaskan dalil sebagai berikut: **Al-Qur'an, lalu Hadits.**
            * Untuk setiap analisa/kajian, **minimal harus memiliki rujukan** dari Al-Qur'an atau Hadits.
            * Analisa bisa menyertakan Ijma' dan Qiyas, dan bahkan bersifat generatif (penjelasan/analogi AI), TAPI ini HANYA boleh sebagai pelengkap dan **harus didasarkan pada dan mendukung rujukan primer** (Al-Qur'an dan Hadits) yang ditemukan.
            * Jika Ijma' atau Qiyas diperlukan, jelaskan bahwa ini adalah ranah ijtihad/analogi dan bukan dalil primer.
        3.  **Format Rujukan:** Untuk setiap rujukan, ikuti format ini:
            - Jika "Quran": Berikan objek dengan properti "type":"Quran", "reference_text":"(QS. Nama Surah: Ayat)", "text":"(Teks Arab diikuti terjemahan)", "tafsir":{"source":"(Nama Kitab Tafsir)", "content":"(Isi tafsir)"}, dan "asbabun_nuzul":{"source":"(Nama Kitab Asbabun Nuzul)", "content":"(Isi detail asbabun nuzul. Jika tidak ada, jelaskan konteks umum surah)"}.
            - Jika "Hadith": Berikan objek dengan properti "type":"Hadith", "text_arabic":"(Teks Arab)", "text_translation":"(Terjemahan Indonesia)", "grade":"(Sahih atau Hasan)", "source":"(Contoh: HR. Bukhari no. 123)"}.
`;
        
        // --- FUNGSI UTILITAS & API ---
        function showLoading(message, targetId = 'results-container') {
            const container = document.getElementById(targetId);
            if(container) {
                const activeView = document.querySelector('.nav-item.active')?.dataset.view;
                if (activeView && viewCache.hasOwnProperty(activeView)) {
                    viewCache[activeView] = null;
                }
                container.innerHTML = `<div class="flex flex-col justify-center items-center p-8 text-center"><svg class="animate-spin h-12 w-12 text-emerald-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-lg text-gray-400">${message}</p></div>`;
            }
        }

        function showError(message, targetId = 'results-container') {
            const container = document.getElementById(targetId);
            if(container) {
                container.innerHTML = `<div class="bg-red-900/50 text-red-300 p-4 rounded-lg border border-red-700 text-center"><h3 class="font-bold">Terjadi Kesalahan</h3><p>${message}</p></div>`;
            }
        }

        async function callGeminiAPI(payload, retries = 3, delay = 1000) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) throw new Error("API Key Gemini belum disimpan. Silakan masukkan di panel Pengaturan.");
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`API Error Response (Attempt ${i + 1}/${retries}):`, errorBody);
                        
                        if ((response.status === 503 || response.status === 429) && i < retries - 1) {
                            console.log(`Retrying in ${delay / 1000} seconds...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            continue;
                        } else {
                            throw new Error(`Terjadi masalah saat menghubungi API (Error ${response.status}). Cek API Key Anda atau coba lagi nanti.`);
                        }
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                        try {
                            const rawText = result.candidates[0].content.parts[0].text;
                            const cleanText = rawText.replace(/^```json\s*|```$/g, '');
                            return JSON.parse(cleanText);
                        } catch(e) {
                            console.error("Gagal mem-parsing JSON dari respons Gemini:", e, "Raw Text:", result.candidates[0].content.parts[0].text);
                            throw new Error("Gemini memberikan respons yang tidak valid (bukan format JSON).");
                        }
                    } else {
                        console.error("Unexpected API response structure:", result);
                        throw new Error("Struktur respons dari API tidak terduga.");
                    }
                } catch (error) {
                    if (i === retries - 1 || !(error instanceof TypeError) && !(error.message.includes('Failed to fetch'))) {
                        throw error;
                    }
                    console.error(`Network or unexpected error (Attempt ${i + 1}/${retries}):`, error);
                    console.log(`Retrying in ${delay / 1000} seconds...`);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            throw new Error("Gagal menghubungi API Gemini setelah beberapa kali percobaan. Silakan coba lagi nanti.");
        }

        // --- FUNGSI EXPORT ---
        async function exportResultToPDF() {
            const exportButton = document.getElementById('export-btn');
            const contentToExport = document.getElementById('exportable-content');
            
            if (!contentToExport) {
                showError("Tidak ada konten untuk diekspor.");
                return;
            }
            if (typeof jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                showError("Library PDF belum termuat, coba lagi sesaat.");
                return;
            }

            if(exportButton) exportButton.textContent = 'Mengekspor...';

            const detailsElements = contentToExport.querySelectorAll('details');
            const originalStates = [];
            detailsElements.forEach(details => {
                originalStates.push(details.open);
                details.open = true;
            });
            
            await new Promise(resolve => setTimeout(resolve, 100));

            try {
                const canvas = await html2canvas(contentToExport, {
                    scale: 2, 
                    backgroundColor: '#1f2937'
                });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }
                
                const today = new Date().toISOString().slice(0, 10);
                pdf.save(`Kajian-Nur-${today}.pdf`);

            } catch (error) {
                console.error("Gagal ekspor ke PDF:", error);
                showError("Terjadi kesalahan saat membuat file PDF.");
            } finally {
                 if(exportButton) exportButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg><span>Export ke PDF</span>`;
                 
                 detailsElements.forEach((details, index) => {
                    details.open = originalStates[index];
                 });
            }
        }
        // --- FUNGSI-FUNGSI RENDERING ---
        function getHadithBadge(grade) {
            if (!grade) return '';
            grade = grade.toLowerCase();
            if (grade === 'sahih') return `<span class="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">Sahih</span>`;
            if (grade === 'hasan') return `<span class="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200">Hasan</span>`;
            return '';
        }

        function renderMadhhabAnalysis(originalTopic) {
            const madhhabs = ['Hanafi', 'Maliki', 'Syafi\'i', 'Hanbali'];
            let buttonsHtml = madhhabs.map(m =>
                `<button class="madhhab-btn text-left text-sm bg-gray-700 hover:bg-gray-600 text-emerald-300 px-4 py-2 rounded-lg transition-colors" data-madhhab="${m}">${m}</button>`
            ).join('');
            
            buttonsHtml += `<button class="compare-all-btn text-left text-sm bg-teal-700 hover:bg-teal-600 text-white font-bold px-4 py-2 rounded-lg transition-colors">Bandingkan Semua</button>`;

            return `<div class="mt-8 pt-6 border-t border-gray-700" data-original-topic="${originalTopic}"><h3 class="text-lg font-semibold text-white mb-4">Analisa Lintas Mazhab</h3><div class="flex flex-wrap gap-3">${buttonsHtml}</div></div>`;
        }

        function renderFollowUpQuestions(questions) {
            if (!questions || questions.length === 0) return '';
            const buttonsHtml = questions.map(q => `<button class="follow-up-btn text-left text-sm bg-gray-700 hover:bg-gray-600 text-emerald-300 px-4 py-2 rounded-lg transition-colors" data-followup-query="${q}">${q}</button>`).join('');
            const customQuestionForm = `<form class="custom-follow-up-form mt-4 flex gap-2"><input type="text" placeholder="Ajukan pertanyaanmu sendiri..." class="flex-grow px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"><button type="submit" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors">Tanya</button></form>`;
            return `<div class="mt-8 pt-6 border-t border-gray-700"><h3 class="text-lg font-semibold text-white mb-4">Lanjutkan Diskusi:</h3><div class="flex flex-wrap gap-3">${buttonsHtml}</div>${customQuestionForm}</div>`;
        }
        
        function renderReferensi(references) {
            if (!references || references.length === 0) return '';

            const quranRefs = references.filter(ref => ref.type && ref.type.toLowerCase() === 'quran');
            const hadithRefs = references.filter(ref => ref.type && ref.type.toLowerCase() === 'hadith');

            let referencesHtml = '';

            if (quranRefs.length > 0) {
                referencesHtml += `<h3 class="text-xl font-semibold text-white border-b-2 border-emerald-500/50 pb-2 mb-4">Rujukan Al-Qur'an</h3>`;
                quranRefs.forEach(ref => {
                    const tafsirHtml = (ref.tafsir && ref.tafsir.content) 
                        ? `<details class="mt-3"><summary>Tafsir (dari ${ref.tafsir.source || 'sumber terpercaya'})</summary><div><p class="text-gray-300 whitespace-pre-wrap">${ref.tafsir.content}</p></div></details>` 
                        : '';
                    const asbabHtml = (ref.asbabun_nuzul && ref.asbabun_nuzul.content) 
                        ? `<details class="mt-2"><summary>Asbabun Nuzul (dari ${ref.asbabun_nuzul.source || 'sumber terpercaya'})</summary><div><p class="text-gray-300 whitespace-pre-wrap">${ref.asbabun_nuzul.content}</p></div></details>` 
                        : '';
                    
                    referencesHtml += `<div class="bg-gray-900 p-4 rounded-md border-l-4 border-green-500 mb-4">
                                <div class="flex items-center mb-2">
                                    <span class="inline-block px-2 py-1 text-xs font-bold rounded bg-green-500/20 text-green-300">Quran</span>
                                    ${ref.reference_text ? `<span class="ml-2 text-xs font-semibold text-gray-400">${ref.reference_text}</span>` : ''}
                                </div>
                                <p class="text-gray-300 text-right whitespace-pre-wrap text-lg font-arabic mb-2">${ref.text || ''}</p>
                                <p class="text-gray-400 italic whitespace-pre-wrap">"${ref.translation || ''}"</p>
                                ${tafsirHtml}
                                ${asbabHtml}
                            </div>`;
                });
            }

            if (hadithRefs.length > 0) {
                const totalHadithPages = Math.ceil(hadithRefs.length / REFERENCES_PER_PAGE_HADITH);
                const startIdx = currentReferencePage * REFERENCES_PER_PAGE_HADITH;
                const endIdx = startIdx + REFERENCES_PER_PAGE_HADITH;
                const hadithsToShow = hadithRefs.slice(startIdx, endIdx);

                referencesHtml += `<h3 class="text-xl font-semibold text-white border-b-2 border-emerald-500/50 pb-2 mt-6 mb-4">Rujukan Hadis</h3>`;
                hadithsToShow.forEach(ref => {
                    const badge = getHadithBadge(ref.grade);
                    referencesHtml += `<div class="bg-gray-900 p-4 rounded-md border-l-4 border-yellow-500 mb-4">
                                <div class="flex items-center mb-2">
                                    <span class="inline-block px-2 py-1 text-xs font-bold rounded bg-yellow-500/20 text-yellow-300">Hadith</span>
                                    ${badge}
                                </div>
                                <p class="text-gray-300 text-right whitespace-pre-wrap mb-2 font-arabic">${ref.text_arabic || ''}</p>
                                <p class="text-gray-400 italic whitespace-pre-wrap">"${ref.text_translation || ''}"</p>
                                <p class="text-right text-xs text-gray-500 mt-2">${ref.source || ''}</p>
                            </div>`;
                });

                if (totalHadithPages > 1) {
                    referencesHtml += `<div class="flex justify-center items-center space-x-4 mt-4">`;
                    if (currentReferencePage > 0) {
                        referencesHtml += `<button class="pagination-btn px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors" data-direction="prev">&lt; Prev</button>`;
                    }
                    referencesHtml += `<span class="text-gray-400">Halaman ${currentReferencePage + 1} dari ${totalHadithPages}</span>`;
                    if (currentReferencePage < totalHadithPages - 1) {
                        referencesHtml += `<button class="pagination-btn px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors" data-direction="next">Next &gt;</button>`;
                    }
                    referencesHtml += `</div>`;
                }
            }

            return referencesHtml;
        }

        function renderSearchResults(data, status = 'verified') { 
            const resultsContainer = document.getElementById('results-container');
            if (!resultsContainer) return;

            currentReferences = data.references || [];
            currentReferencePage = 0; 

            const referensiHtml = renderReferensi(currentReferences);
            const madhhabHtml = renderMadhhabAnalysis(data.query);
            const followUpHtml = renderFollowUpQuestions(data.follow_up_questions);

            let borderColorClass = '';
            let statusLabel = '';
            let statusIcon = '';

            if (status === 'verified') {
                borderColorClass = 'border-green-700';
                statusLabel = 'Terverifikasi dari Sumber Primer (Al-Qur\'an & Hadis)';
                statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            } else if (status === 'generative') {
                borderColorClass = 'border-yellow-600';
                statusLabel = 'Analisis Generatif oleh AI (Membutuhkan Verifikasi Ahli & Dalil Utama)';
                statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
            }

            const resultHTML = `<div class="bg-gray-800/50 p-8 rounded-lg border ${borderColorClass} animate-fade-in">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex-grow">
                                            <h2 class="text-2xl font-bold text-white">Hasil Analisa: <span class="text-emerald-400">${data.query}</span></h2>
                                            <div class="flex items-center text-sm font-semibold mt-2 text-gray-400">
                                                ${statusIcon}
                                                <span>${statusLabel}</span>
                                             </div>
                                        </div>
                                        <button id="export-btn" class="flex-shrink-0 ml-4 px-3 py-2 text-sm bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg transition-colors flex items-center">
                                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                            <span>Export ke PDF</span>
                                        </button>
                                    </div>
                                    <div id="exportable-content">
                                        <p class="text-gray-300 mb-6 whitespace-pre-wrap">${data.summary}</p>
                                        <div id="references-wrapper">${referensiHtml}</div>
                                    </div>
                                    ${madhhabHtml} 
                                    ${followUpHtml}
                                </div>`;

            viewCache.search = resultHTML;
            resultsContainer.innerHTML = resultHTML;
        }
        
        function renderImageAnalysis(data, imageSrc) {
            const resultsContainer = document.getElementById('results-container');
            if (!resultsContainer) return;
            const referensiHtml = renderReferensi(data.references);
            const followUpHtml = renderFollowUpQuestions(data.follow_up_questions);
            const resultHTML = `<div class="bg-gray-800/50 p-8 rounded-lg border border-gray-700 animate-fade-in"><div class="flex justify-between items-start mb-4"><div class="flex-grow"><h2 class="text-2xl font-bold text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span>Tafsir Visual & Hikmah Gambar</span></h2></div><button id="export-btn" class="flex-shrink-0 ml-4 px-3 py-2 text-sm bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg transition-colors flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg><span>Export ke PDF</span></button></div><div id="exportable-content"><div class="grid md:grid-cols-2 gap-8"><div class="space-y-4"><div><h3 class="text-lg font-semibold text-emerald-400">Deskripsi Gambar</h3><p>${data.description}</p></div><div><h3 class="text-lg font-semibold text-emerald-400">Pelajaran & Hikmah</h3><p>${data.wisdom}</p></div></div><img src="${imageSrc}" class="rounded-lg object-cover w-full h-auto"/></div><div class="mt-8">${referensiHtml}</div></div>${followUpHtml}</div>`;
            
            viewCache.image = resultHTML;
            resultsContainer.innerHTML = resultHTML;
        }

        // --- FUNGSI-FUNGSI AKSI UTAMA ---
        function processQuery(userInput) {
            const lowerCaseInput = userInput.toLowerCase();
            const generativeKeywords = ['ijma', 'qiyas', 'analogi', 'konsensus', 'pendapat ulama umum'];
            const isGenerative = generativeKeywords.some(keyword => lowerCaseInput.includes(keyword));

            if (isGenerative) {
                runGenerativeSearch(userInput);
            } else {
                runQuickAnswerRAG(userInput);
            }
        }

        async function runQuickAnswerRAG(query) {
            const resultsContainer = document.getElementById('results-container');
            if (!resultsContainer) return;
            
            showLoading('Mencari ilmu dan rujukan lengkap dari Al-Qur\'an dan Hadis...', 'results-container');
            resultsContainer.scrollIntoView({ behavior: 'smooth' });

            // Menjalankan proses berat di dalam setTimeout agar UI tidak freeze
            setTimeout(async () => {
                const searchQuran = document.getElementById('filter-quran')?.checked ?? true;
                const searchHadith = document.getElementById('filter-hadith')?.checked ?? true;

                if (!searchQuran && !searchHadith) {
                    showError("Anda harus memilih minimal satu sumber rujukan (Al-Qur'an atau Hadis) untuk melakukan pencarian.");
                    return;
                }

                const relevantDocuments = await findRelevantDocuments(query, 15, { searchQuran, searchHadith });
                
                let contextText = "";
                let referenceObjects = [];

                if (relevantDocuments.length > 0) {
                    contextText += "BERIKUT ADALAH RUJUKAN PRIMER (AL QUR'AN/HADIS) YANG RELEVAN DARI DATABASE LOKAL. GUNAKAN INI SEBAGAI DASAR UTAMA JAWABAN ANDA:\n\n";
                    relevantDocuments.forEach(doc => {
                        if (doc.type === 'Quran') {
                            contextText += `[Qur'an] ${doc.source}: "${doc.translation}"\n`;
                            referenceObjects.push({
                                type: "Quran",
                                reference_text: doc.source,
                                text: doc.text, 
                                translation: doc.translation,
                                tafsir: doc.tafsir || { source: "Tidak tersedia", content: "Tidak ada tafsir spesifik untuk ayat ini dalam database lokal." },
                                asbabun_nuzul: doc.asbabun_nuzul || { source: "Tidak tersedia", content: "Tidak ada asbabun nuzul spesifik untuk ayat ini dalam database lokal." }
                            });
                        } else if (doc.type === 'Hadith') {
                            contextText += `[Hadis] ${doc.source}: "${doc.translation}" (Grade: ${doc.grade || 'Tidak diketahui'})\n`;
                            referenceObjects.push({
                                type: "Hadith",
                                text_arabic: doc.text, 
                                text_translation: doc.translation, 
                                grade: doc.grade || "Tidak diketahui",
                                source: doc.source
                            });
                        }
                    });
                    contextText += "\n";
                } else {
                    contextText += "TIDAK DITEMUKAN RUJUKAN LANGSUNG DARI AL-QUR'AN ATAU HADIS DALAM DATABASE LOKAL YANG SANGAT RELEVAN UNTUK KUERIMU. JAWABAN AKAN LEBIH BERSIFAT GENERATIF BERDASARKAN PEMAHAMAN AI. INGATLAH BAHWA DALIL PRIMER ADALAH FONDASI ILMU.\n\n";
                }

                const prompt = `${pilar2PromptInstruction}

                **TOPIK ANALISIS:** "${query}"

                **KONTEKS RUJUKAN PRIMER DARI DATABASE LOKAL (AL-QUR'AN & HADIS):**
                ${contextText}

                **INSTRUKSI JAWABAN:**
                Sebagai seorang cendekiawan Muslim, analisis dan jawablah topik "${query}" berdasarkan **SEPENUHNYA** dari 'KONTEKS RUJUKAN PRIMER' yang diberikan di atas.
                Jika rujukan primer yang diberikan TIDAK CUKUP untuk menjawab pertanyaan, nyatakan demikian dan jelaskan bahwa analisis selanjutnya bersifat ijtihad, qiyas, atau generatif dan butuh verifikasi lebih lanjut oleh ahli.
                Prioritaskan penyebutan rujukan Al-Qur'an terlebih dahulu, diikuti Hadis.
                Pastikan properti 'references' dalam JSON berisi **SEMUA** rujukan yang Anda gunakan dari 'KONTEKS RUJUKAN PRIMER'.

                Berikan jawaban dalam format JSON: {"query": string, "summary": string, "references": [/* array of Quran/Hadith objects */], "follow_up_questions": [string, string, string]}`;

                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };

                try {
                    const resultData = await callGeminiAPI(payload);
                    
                    if (referenceObjects.length > 0) {
                        resultData.references = referenceObjects;
                        renderSearchResults(resultData, 'verified');
                    } else {
                        const generativePrompt = `${pilar2PromptInstruction}
                        Anda diminta untuk menganalisis topik: "${query}".
                        **PENTING:** Karena tidak ditemukan rujukan langsung dari Al-Qur'an atau Hadis dalam database lokal, jawaban ini adalah analisis generatif oleh AI.
                        Sebutkan secara eksplisit jika jawaban Anda berdasarkan ijtihad atau qiyas dan bahwa ini memerlukan verifikasi lebih lanjut oleh ahli atau ulama.
                        Berikan jawaban dalam format JSON: {"query": string, "summary": string, "references": [], "follow_up_questions": [string, string, string]}`;
                        
                        const generativePayload = { contents: [{ parts: [{ text: generativePrompt }] }], generationConfig: { responseMimeType: "application/json" } };
                        const generativeResult = await callGeminiAPI(generativePayload);
                        renderSearchResults(generativeResult, 'generative');
                    }
                    
                } catch (error) {
                    showError(error.message, 'results-container');
                }
            }, 0);
        }
        // --- FUNGSI PENCARIAN CERDAS (VERSI BARU) ---
        async function findRelevantDocuments(query, limit = 15, options = { searchQuran: true, searchHadith: true }) {
            const allFoundDocs = []; 
            const lowerCaseQuery = query.toLowerCase().trim();
            const { searchQuran, searchHadith } = options;

            const stopWords = new Set(['cara', 'dan', 'yang', 'dari', 'tentang', 'mengenai', 'untuk', 'adalah', 'ini', 'itu', 'apa', 'siapa', 'kapan', 'dimana', 'bagaimana', 'menurut', 'pandangan', 'dalam', 'hukumnya']);
            
            const queryWords = lowerCaseQuery.split(/\s+/).filter(word => word.length > 2 && !stopWords.has(word));

            loadedDatabase.forEach(doc => {
                if (!searchQuran && doc.type === 'Quran') return;
                if (!searchHadith && doc.type === 'Hadith') return;

                let relevanceScore = 0;
                const contentToSearch = ((doc.translation || '') + ' ' + (doc.text || '')).toLowerCase();

                // STRATEGI #1: Pencarian Frasa Utuh (Skor Tertinggi)
                if (lowerCaseQuery.length > 3 && contentToSearch.includes(lowerCaseQuery)) {
                    relevanceScore += 1000;
                }

                // STRATEGI #2: Semua Kata Kunci Penting Ada (Skor Tinggi)
                if (queryWords.length > 1) {
                    const allWordsFound = queryWords.every(word => contentToSearch.includes(word));
                    if (allWordsFound) {
                        relevanceScore += 100;
                    }
                }
                
                // HANYA DOKUMEN BERKUALITAS TINGGI YANG AKAN DIPROSES
                if (relevanceScore >= 100) {
                    // Cek duplikat sebelum menambahkan
                    if (!allFoundDocs.some(found => found.doc.id === doc.id)) {
                         allFoundDocs.push({ doc, score: relevanceScore });
                    }
                }
            });

            allFoundDocs.sort((a, b) => b.score - a.score);

            const uniqueRelevantDocs = allFoundDocs.map(item => item.doc);
            
            console.log(`DEBUG: findRelevantDocuments for "${query}" - Found: ${uniqueRelevantDocs.length} docs (before slice)`);
            return uniqueRelevantDocs.slice(0, limit);
        }

        // --- INISIALISASI PANEL ---
        const panelInitializers = {
            
            'unified-search': function() {
                const panel = document.getElementById('unified-search-panel');
                if (!panel) return;
                panel.innerHTML = `<h2 class="text-3xl font-bold text-white mb-6">Pencarian & Riset</h2><form id="unified-search-form" class="relative"><textarea id="unified-search-input" rows="5" placeholder="Ketik topik, pertanyaan, atau referensi (misal: QS. Al-Baqarah: 183, HR. Bukhari tentang niat)..." class="w-full p-4 pr-12 bg-gray-800 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea><button type="button" class="dictation-btn absolute top-4 right-4 text-gray-400 hover:text-emerald-400" data-target="unified-search-input"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg></button><button type="submit" class="mt-4 w-full px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition-colors">Jalankan Pencarian</button><div class="mt-4 flex items-center justify-center space-x-6"><label for="filter-quran" class="flex items-center text-gray-300 cursor-pointer"><input type="checkbox" id="filter-quran" class="form-checkbox h-5 w-5 bg-gray-700 border-gray-600 rounded text-emerald-500 focus:ring-emerald-500" checked><span class="ml-2">Al-Qur'an</span></label><label for="filter-hadith" class="flex items-center text-gray-300 cursor-pointer"><input type="checkbox" id="filter-hadith" class="form-checkbox h-5 w-5 bg-gray-700 border-gray-600 rounded text-emerald-500 focus:ring-emerald-500" checked><span class="ml-2">Hadis</span></label></div></form>`;
                
                panel.querySelector('#unified-search-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const query = panel.querySelector('#unified-search-input').value.trim();
                    if (query) processQuery(query); 
                });
            },
            image: function() {
                const panel = document.getElementById('image-panel');
                if (!panel) return;
                panel.innerHTML = `<h2 class="text-3xl font-bold text-white mb-6">Hikmah Gambar</h2><div class="max-w-md mx-auto text-center"><div id="image-display-area" class="mb-4 h-64 bg-gray-800 border-2 border-dashed border-gray-700 rounded-lg flex items-center justify-center overflow-hidden"><p id="image-placeholder" class="text-gray-500">Pilih gambar atau gunakan kamera</p><img id="image-preview" src="" class="hidden max-h-full max-w-full rounded-lg"/><video id="camera-stream" class="hidden w-full h-full object-cover" autoplay></video></div><canvas id="camera-canvas" class="hidden"></canvas><div id="image-controls" class="space-y-2"><div class="flex space-x-2"><button id="upload-btn" class="w-full px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition-colors">Upload Gambar</button><button id="camera-btn" class="w-full px-6 py-3 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-lg transition-colors">Gunakan Kamera</button></div></div><div id="capture-controls" class="hidden space-y-2"><button id="capture-btn" class="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors">Ambil Foto</button><button id="switch-camera-btn" class="w-full text-sm py-2 text-gray-300 hover:text-white transition-colors">Kamera Belakang</button><button id="cancel-camera-btn" class="w-full text-sm text-gray-400 hover:text-white transition-colors">Batal</button></div><input type="file" id="image-input" class="hidden" accept="image/*"/></div>`;
                
                const imageInput = panel.querySelector('#image-input');
                const uploadBtn = panel.querySelector('#upload-btn');
                const cameraBtn = panel.querySelector('#camera-btn');
                const imagePreview = panel.querySelector('#image-preview');
                const imagePlaceholder = panel.querySelector('#image-placeholder');
                const cameraStream = panel.querySelector('#camera-stream');
                const cameraCanvas = panel.querySelector('#camera-canvas');
                const imageControls = panel.querySelector('#image-controls');
                const captureControls = panel.querySelector('#capture-controls');
                const captureBtn = panel.querySelector('#capture-btn');
                const cancelCameraBtn = panel.querySelector('#cancel-camera-btn');
                
                let currentFacingMode = 'user';

                const stopCamera = () => {
                    if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); }
                    imageControls.classList.remove('hidden');
                    captureControls.classList.add('hidden');
                    cameraStream.classList.add('hidden');
                    imagePlaceholder.classList.remove('hidden');
                };
                
                async function startCamera(facingMode) {
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                    }
                    const constraints = { video: { facingMode: facingMode } };
                    try {
                        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                        cameraStream.srcObject = currentStream;
                        imageControls.classList.add('hidden');
                        captureControls.classList.remove('hidden');
                        imagePlaceholder.classList.add('hidden');
                        imagePreview.classList.add('hidden');
                        cameraStream.classList.remove('hidden');
                    } catch (err) {
                        showError(`Gagal mengakses kamera. Pastikan Anda memberikan izin.`);
                        stopCamera();
                    }
                }

                const analyzeImage = async (base64Data, mimeType) => {
                    showLoading('Mengolah gambar dan menggali hikmah...');
                    document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
                    const prompt = `${pilar2PromptInstruction} Berdasarkan prinsip di atas, lihat gambar ini, deskripsikan, dan gali hikmahnya. Berikan jawaban JSON: {"description": string, "wisdom": string, "references": [/* array of Quran/Hadith objects */], "follow_up_questions": [string, string, string]}`;
                    const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: mimeType, data: base64Data } }] }], generationConfig: { responseMimeType: "application/json" } };
                    try {
                        const resultData = await callGeminiAPI(payload);
                        renderImageAnalysis(resultData, `data:${mimeType};base64,${base64Data}`);
                    } catch (error) { showError(error.message); }
                };

                uploadBtn.addEventListener('click', () => imageInput.click());
                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = () => {
                        const base64Data = reader.result.split(',')[1];
                        imagePreview.src = reader.result;
                        imagePreview.classList.remove('hidden');
                        imagePlaceholder.classList.add('hidden');
                        analyzeImage(base64Data, file.type);
                    };
                });

                if (hasCameraSupport && isSecureContext) {
                    cameraBtn.addEventListener('click', () => startCamera(currentFacingMode));
                    
                    const switchCameraBtn = panel.querySelector('#switch-camera-btn');
                    if(switchCameraBtn) {
                        switchCameraBtn.addEventListener('click', () => {
                            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
                            startCamera(currentFacingMode);
                        });
                    }

                } else {
                    cameraBtn.classList.add('secure-feature-disabled');
                    cameraBtn.title = "Fitur kamera memerlukan koneksi aman (HTTPS).";
                    cameraBtn.onclick = () => showError(cameraBtn.title);
                }
                
                cancelCameraBtn.addEventListener('click', stopCamera);
                captureBtn.addEventListener('click', () => {
                    cameraCanvas.width = cameraStream.videoWidth;
                    cameraCanvas.height = cameraStream.videoHeight;
                    cameraCanvas.getContext('2d').drawImage(cameraStream, 0, 0);
                    const imageDataUrl = cameraCanvas.toDataURL('image/jpeg');
                    const base64Data = imageDataUrl.split(',')[1];
                    imagePreview.src = imageDataUrl;
                    imagePreview.classList.remove('hidden');
                    stopCamera();
                    analyzeImage(base64Data, 'image/jpeg');
                });
            },
            settings: function() {
                const panel = document.getElementById('settings-panel');
                if (!panel) return;
                panel.innerHTML = `
                    <h2 class="text-3xl font-bold text-white mb-6">Pengaturan</h2>
                    <div class="max-w-xl mx-auto p-4 bg-gray-800/50 border border-gray-700 rounded-lg">
                        <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key Anda</label>
                        <div class="flex items-center space-x-2">
                            <input id="api-key-input" type="password" placeholder="Masukkan API Key dari Google AI Studio" class="flex-grow px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"/>
                            <button id="save-api-key-btn" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-md transition-colors">Simpan</button>
                        </div>
                        <p id="api-key-status" class="text-xs text-gray-500 mt-2"></p>
                        <p class="text-center text-xs text-gray-500 mt-3">Tidak punya API Key? Dapatkan di <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-emerald-400 hover:underline">Google AI Studio</a>.</p>
                    </div>

                    <div class="max-w-xl mx-auto p-4 bg-gray-800/50 border border-gray-700 rounded-lg mt-6">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Muat Database Al-Qur'an & Hadis</label>
                        <div class="flex items-center space-x-3 mt-2">
                            <label for="database-file-input" class="w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-md transition-colors cursor-pointer">
                                Pilih File Lokal
                            </label>
                            <input type="file" id="database-file-input" accept=".json" class="hidden"/>
                            <button id="load-from-github-btn" class="w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-md transition-colors">
                                Load dari GitHub
                            </button>
                        </div>
                        <p id="database-status" class="text-center text-xs text-gray-500 mt-3">Pilih file lokal atau muat langsung dari GitHub.</p>
                    </div>
                    `;
                
                const apiKeyInput = panel.querySelector('#api-key-input');
                const saveApiKeyBtn = panel.querySelector('#save-api-key-btn');
                const apiKeyStatus = panel.querySelector('#api-key-status');

                const saveApiKey = () => {
                    const key = apiKeyInput.value.trim();
                    if (key) {
                        localStorage.setItem('geminiApiKey', key);
                        apiKeyStatus.textContent = 'API Key berhasil disimpan!';
                        apiKeyStatus.className = 'text-xs text-green-400 mt-2 opacity-100 transition-opacity duration-300';
                    } else {
                        localStorage.removeItem('geminiApiKey');
                        apiKeyStatus.textContent = 'API Key dihapus dari penyimpanan.';
                        apiKeyStatus.className = 'text-xs text-yellow-400 mt-2 opacity-100 transition-opacity duration-300';
                    }
                    setTimeout(() => { 
                        if(apiKeyStatus) {
                            apiKeyStatus.classList.remove('opacity-100');
                            apiKeyStatus.classList.add('opacity-0'); 
                        }
                    }, 3000);
                };
                
                const loadApiKey = () => {
                    const savedKey = localStorage.getItem('geminiApiKey');
                    if (savedKey) {
                        apiKeyInput.value = savedKey;
                        apiKeyStatus.textContent = 'API Key berhasil dimuat dari penyimpanan browser.';
                        apiKeyStatus.className = 'text-xs text-green-400 mt-2';
                    } else {
                        apiKeyStatus.textContent = 'Silakan masukkan Gemini API Key Anda untuk memulai.';
                        apiKeyStatus.className = 'text-xs text-yellow-400 mt-2';
                    }
                };
                
                saveApiKeyBtn.addEventListener('click', saveApiKey);
                loadApiKey();

                const loadFromGithubBtn = panel.querySelector('#load-from-github-btn');
                const dbStatus = panel.querySelector('#database-status');

                if (loadFromGithubBtn) {
                    loadFromGithubBtn.addEventListener('click', async () => {
                        const githubUrl = 'https://media.githubusercontent.com/media/opixtm/nur/main/database.json';
                        
                        dbStatus.textContent = 'Mengunduh database dari GitHub, mohon tunggu...';
                        dbStatus.className = 'text-center text-xs text-yellow-400 mt-3';

                        try {
                            const response = await fetch(githubUrl);
                            if (!response.ok) {
                                throw new Error(`Gagal mengunduh: Server merespons dengan status ${response.status}`);
                            }
                            const rawText = await response.text();
                            const cleanText = rawText.trim();
                            const data = JSON.parse(cleanText);
                            
                            loadedDatabase = data;
                            
                            dbStatus.textContent = `Database dari GitHub berhasil dimuat. Total ${loadedDatabase.length} entri.`;
                            dbStatus.className = 'text-center text-xs text-green-400 mt-3';
                            console.log('Database dari GitHub berhasil dimuat!', loadedDatabase.length, 'entri.');

                        } catch (error) {
                            dbStatus.textContent = `Gagal memuat dari GitHub: ${error.message}`;
                            dbStatus.className = 'text-center text-xs text-red-400 mt-3';
                            console.error('Error loading from GitHub:', error);
                        }
                    });
                }

                const databaseFileInput = panel.querySelector('#database-file-input');
                const databaseStatus = panel.querySelector('#database-status');

                if (databaseFileInput) {
                    databaseFileInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            databaseStatus.textContent = 'Memuat database, mohon tunggu...';
                            databaseStatus.className = 'text-xs text-yellow-400 mt-2';
                            try {
                                await loadDatabase(file);
                                databaseStatus.textContent = `Database "${file.name}" berhasil dimuat. Total ${loadedDatabase.length} entri.`;
                                databaseStatus.className = 'text-xs text-green-400 mt-2';
                            } catch (error) {
                                databaseStatus.textContent = `Gagal memuat database: ${error.message}`;
                                databaseStatus.className = 'text-xs text-red-400 mt-2';
                                console.error('Error loading database:', error);
                            }
                        } else {
                            databaseStatus.textContent = 'Belum ada database dimuat. Pilih file database.json Anda.';
                            databaseStatus.className = 'text-xs text-gray-500 mt-2';
                        }
                    });
                }
            },  
        }; 

        const panelInitialized = {};

        function switchView(viewName) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('panel-active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            const navButton = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (navButton) navButton.classList.add('active');
            
            const activePanel = document.getElementById(`${viewName}-panel`);
            if (activePanel) activePanel.classList.add('panel-active');

            if (!panelInitialized[viewName]) {
                if (panelInitializers[viewName]) {
                    panelInitializers[viewName]();
                }
                panelInitialized[viewName] = true;
            }
            
            const resultsContainer = document.getElementById('results-container');
            if (viewCache.hasOwnProperty(viewName) && viewCache[viewName]) {
                resultsContainer.innerHTML = viewCache[viewName];
            } else {
                resultsContainer.innerHTML = '';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const mainNav = document.getElementById('main-nav');
            if (mainNav) {
                mainNav.addEventListener('click', (e) => {
                    const navItem = e.target.closest('.nav-item');
                    if (navItem && navItem.dataset.view) {
                        switchView(navItem.dataset.view);
                    }
                });
            }

            const resultsContainer = document.getElementById('results-container'); 
            if (resultsContainer) {
                resultsContainer.addEventListener('click', (e) => {
                    if (e.target.matches('.pagination-btn')) {
                        const direction = e.target.dataset.direction;
                        if (direction === 'prev') {
                            currentReferencePage = Math.max(0, currentReferencePage - 1);
                        } else if (direction === 'next') {
                            currentReferencePage++;
                        }
                        
                        const wrapper = document.getElementById('references-wrapper');
                        if (wrapper) {
                            wrapper.innerHTML = renderReferensi(currentReferences);
                        }
                        return;
                    }

                    const madhhabBtn = e.target.closest('.madhhab-btn');
                    if (madhhabBtn) {
                        const madhhab = madhhabBtn.dataset.madhhab;
                        const originalTopic = madhhabBtn.closest('[data-original-topic]').dataset.originalTopic;
                        processQuery(`Jelaskan pandangan Mazhab ${madhhab} tentang ${originalTopic} secara mendalam`); 
                        return;
                    }

                    const compareBtn = e.target.closest('.compare-all-btn');
                    if(compareBtn) {
                        const originalTopic = compareBtn.closest('[data-original-topic]').dataset.originalTopic;
                        processQuery(`Buat perbandingan ringkas pandangan 4 mazhab (Hanafi, Maliki, Syafi'i, Hanbali) tentang topik: "${originalTopic}". Sajikan dalam format tabel jika memungkinkan.`);
                        return;
                    }

                    if (e.target.closest('#export-btn')) {
                        exportResultToPDF();
                        return;
                    }
                    
                    if (e.target.matches('.follow-up-btn')) {
                        processQuery(e.target.dataset.followupQuery);
                    }
                });
                resultsContainer.addEventListener('submit', (e) => {
                    if (e.target.matches('.custom-follow-up-form')) {
                        e.preventDefault();
                        const input = e.target.querySelector('input[type="text"]');
                        if(input && input.value) processQuery(input.value.trim());
                    }
                });
            }

            if (SpeechRecognition && isSecureContext) {
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'id-ID';
                recognition.interimResults = false;
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const targetId = recognition.targetInputId;
                    const targetInput = document.getElementById(targetId);
                    if (targetInput) targetInput.value = transcript;
                };
                recognition.onerror = (event) => { showError(`Error dikte: ${event.error}`); };
                recognition.onend = () => { document.querySelectorAll('.dictation-btn').forEach(btn => btn.classList.remove('recording')); };
                document.body.addEventListener('click', (e) => {
                    if(e.target.matches('.dictation-btn') || e.target.closest('.dictation-btn')) {
                        const btn = e.target.closest('.dictation-btn');
                        recognition.targetInputId = btn.dataset.target;
                        btn.classList.add('recording');
                        recognition.start();
                    }
                });
            } else {
                document.querySelectorAll('.dictation-btn').forEach(btn => {
                    btn.classList.add('secure-feature-disabled');
                    btn.title = "Fitur dikte memerlukan koneksi aman (HTTPS).";
                });
            }

            switchView('unified-search');
        });
    </script>
</body>
</html>
